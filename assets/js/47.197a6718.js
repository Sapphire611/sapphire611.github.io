(window.webpackJsonp=window.webpackJsonp||[]).push([[47],{463:function(t,s,a){"use strict";a.r(s);var n=a(1),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"title"}),s("p",[t._v("ORM: Mongoose")]),t._v(" "),s("p",[t._v("Reference: https://mongoosejs.com/docs/middleware.html")]),t._v(" "),s("p",[t._v("ä»£ç å¯ä»¥å¤åˆ¶åˆ°æœ¬åœ°ï¼Œå®‰è£…ä¾èµ–åç›´æ¥è¿è¡Œï½")])]),s("h2",{attrs:{id:"_1-å‰è¨€"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-å‰è¨€"}},[t._v("#")]),t._v(" 1. å‰è¨€")]),t._v(" "),s("blockquote",[s("p",[t._v("MongoDBçš„Hookç›‘å¬æ˜¯ä¸€ç§åœ¨æ•°æ®åº“æ“ä½œå‰åæ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘çš„åŠŸèƒ½,\nä¾‹å¦‚åœ¨æ’å…¥æ•°æ®å‰å¯¹æ•°æ®è¿›è¡ŒåŠ å·¥, åœ¨åˆ é™¤æ•°æ®åå¯¹æ•°æ®è¿›è¡Œæ¸…ç†ç­‰ç­‰")])]),t._v(" "),s("blockquote",[s("p",[t._v("å…¶ä¸­preHookä»£è¡¨åœ¨æ“ä½œå‰æ‰§è¡Œ, postHookä»£è¡¨åœ¨æ“ä½œåæ‰§è¡Œ")])]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"title"}),s("p",[t._v("ğŸ‘€ é€‚ç”¨åœºæ™¯")]),t._v(" "),s("ol",[s("li",[t._v("å®‰å…¨æ€§æ§åˆ¶ï¼šæ‚¨å¯ä»¥ä½¿ç”¨ MongoDB Hook æ¥å®ç°å®‰å…¨æ€§æ§åˆ¶ï¼Œä¾‹å¦‚åœ¨æŸ¥è¯¢æˆ–æ›´æ–°æ“ä½œå‰éªŒè¯ç”¨æˆ·çš„æƒé™ã€‚")]),t._v(" "),s("li",[t._v("æ•°æ®è½¬æ¢å’Œæ ¼å¼åŒ–ï¼šæ‚¨å¯ä»¥åœ¨ MongoDB Hook ä¸­ç¼–å†™ä»£ç ï¼Œå°†æ•°æ®è¿›è¡Œæ ¼å¼åŒ–æˆ–è½¬æ¢ï¼Œä»¥æ»¡è¶³åº”ç”¨ç¨‹åºçš„éœ€æ±‚ã€‚")]),t._v(" "),s("li",[t._v("å®¡è®¡æ—¥å¿—ï¼šé€šè¿‡ä½¿ç”¨ MongoDB Hookï¼Œæ‚¨å¯ä»¥è®°å½•æ•°æ®åº“æ“ä½œçš„ç›¸å…³ä¿¡æ¯ã€ç±»å‹ã€æ‰§è¡Œæ—¶é—´å’Œç»“æœç­‰ã€‚")]),t._v(" "),s("li",[t._v("æ‰©å±•ç´¢å¼•ï¼šæ‚¨å¯ä»¥ä½¿ç”¨ MongoDB Hook åˆ›å»ºè‡ªå®šä¹‰ç´¢å¼•ï¼Œä»¥æ»¡è¶³ç‰¹å®šçš„æŸ¥è¯¢éœ€æ±‚ã€‚")]),t._v(" "),s("li",[t._v("æ•°æ®å¡«å……å’Œä¿®æ­£ï¼šåœ¨æ’å…¥æˆ–æ›´æ–°æ“ä½œåï¼Œå¯ä»¥æ·»åŠ é¢å¤–çš„é€»è¾‘ï¼Œä¾‹å¦‚å¡«å……é»˜è®¤å€¼ã€æ‰§è¡Œæ ¡éªŒç­‰ã€‚")])])]),s("hr"),t._v(" "),s("h3",{attrs:{id:"ç¤ºä¾‹1-ç®€å•ä½¿ç”¨"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ç¤ºä¾‹1-ç®€å•ä½¿ç”¨"}},[t._v("#")]),t._v(" ç¤ºä¾‹1 ç®€å•ä½¿ç”¨")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" mongoose "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mongoose'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// è¿æ¥MongoDBæ•°æ®åº“")]),t._v("\nmongoose"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("connect")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mongodb://localhost:27017/test'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("useNewUrlParser")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("useUnifiedTopology")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å®šä¹‰Useræ¨¡å‹  ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" UserSchema "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("mongoose"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Schema")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" String"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("age")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Number"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å®šä¹‰prehook  ")]),t._v("\nUserSchema"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pre")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'save'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// åœ¨ä¿å­˜æ–‡æ¡£ä¹‹å‰æ‰§è¡Œä¸€äº›æ“ä½œï¼Œä¾‹å¦‚ç”Ÿæˆå”¯ä¸€çš„IDæˆ–æ·»åŠ æ—¶é—´æˆ³ç­‰  ")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Pre-save hook called'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å®šä¹‰posthook  ")]),t._v("\nUserSchema"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("post")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'save'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("doc")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// åœ¨ä¿å­˜æ–‡æ¡£ä¹‹åæ‰§è¡Œä¸€äº›æ“ä½œï¼Œä¾‹å¦‚å‘é€é‚®ä»¶æˆ–è®°å½•æ—¥å¿—ç­‰  ")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Post-save hook called'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// è¿™é‡Œä¸éœ€è¦next()")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" User "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mongoose"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("model")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'User'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" UserSchema"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// åˆ›å»ºä¸€ä¸ªæ–°Userå¹¶ä¿å­˜  ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" newUser "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("User")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'John Doe'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("age")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nnewUser"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("save")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("è¾“å‡º:")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("Pre"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("save hook called\nPost"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("save hook called\n")])])]),s("hr"),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"title"}),s("p",[t._v("ğŸ‘€ åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªUseræ¨¡å‹ï¼Œå¹¶åœ¨å…¶ä¸Šå®šä¹‰äº†ä¸¤ä¸ªé’©å­ï¼šä¸€ä¸ªprehookå’Œä¸€ä¸ªposthookã€‚\nprehookå°†åœ¨ä¿å­˜æ–‡æ¡£ä¹‹å‰è°ƒç”¨ï¼Œè€Œposthookå°†åœ¨ä¿å­˜æ–‡æ¡£ä¹‹åè°ƒç”¨ã€‚\næˆ‘ä»¬å¯ä»¥åœ¨prehookä¸­æ‰§è¡Œä¸€äº›å‰ç½®é€»è¾‘ï¼Œåœ¨posthookä¸­æ‰§è¡Œä¸€äº›åç½®é€»è¾‘ï¼Œ\nåˆ›å»ºæ–°çš„å®ä¾‹å¹¶ä¿å­˜åˆ°æ•°æ®åº“ä¸­æ—¶ï¼Œä¼šåŒæ—¶è§¦å‘é’©å­å‡½æ•°ã€‚")])]),s("h3",{attrs:{id:"ç¤ºä¾‹2-æ£€æŸ¥bookingçš„å¼€å§‹ç»“æŸæ—¶é—´"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ç¤ºä¾‹2-æ£€æŸ¥bookingçš„å¼€å§‹ç»“æŸæ—¶é—´"}},[t._v("#")]),t._v(" ç¤ºä¾‹2 æ£€æŸ¥Bookingçš„å¼€å§‹ç»“æŸæ—¶é—´")]),t._v(" "),s("blockquote",[s("p",[t._v("å‡è®¾æœ‰ä¸€ä¸ªé¢„è®¢ï¼Œåˆ›å»ºé¢„è®¢çš„æ—¶å€™éœ€è¦ä¿è¯æ•°æ®æ»¡è¶³: beginAt < endAt ï¼ˆä¼šè®®å¼€å§‹æ—¶é—´å¿…é¡»å°äºä¼šè®®ç»“æŸæ—¶é—´ï¼‰")])]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" mongoose "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mongoose'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// è¿æ¥MongoDBæ•°æ®åº“")]),t._v("\nmongoose"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("connect")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mongodb://localhost:27017/test'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("useNewUrlParser")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("useUnifiedTopology")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å®šä¹‰Useræ¨¡å‹  ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" BookingSchema "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("mongoose"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Schema")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" String"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("beginAt")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Number"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("endAt")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Number"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å®šä¹‰prehook  ")]),t._v("\nBookingSchema"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pre")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'save'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// console.log(this)")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å¦‚æœbeginAtå¤§äºendAtï¼Œåˆ™æŠ¥é”™")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("beginAt "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("endAt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'beginAt must be less than endAt'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// æˆ–è€…ï¼šthrow Error('beginAt must be less than endAt')")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" Booking "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mongoose"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("model")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Booking'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" BookingSchema"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// åˆ›å»ºä¸€ä¸ªæ–°Bookingå¹¶ä¿å­˜  ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" booking "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Booking")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'booking'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("beginAt")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("321")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("endAt")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("123")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nbooking"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("save")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("blockquote",[s("p",[t._v("ğŸ‘€ ä»¥ä¸Šä»£ç å¯ä»¥è¿è¡Œï¼Œé¢„æœŸç»“æœæ˜¯æŠ›å‡º beginAt must be less than endAtçš„é”™è¯¯")])]),t._v(" "),s("h3",{attrs:{id:"post-middleware-å¯¹åº”æ‰§è¡Œé¡ºåº"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#post-middleware-å¯¹åº”æ‰§è¡Œé¡ºåº"}},[t._v("#")]),t._v(" * Post middleware å¯¹åº”æ‰§è¡Œé¡ºåº")]),t._v(" "),s("ul",[s("li",[t._v("æŒ‚é’©æ–¹æ³•åï¼Œä¸­é—´ä»¶å°†æ‰§è¡Œï¼Œåœ¨å…¶æ‰€æœ‰preä¸­é—´ä»¶éƒ½å·²å®Œæˆåï¼Œæ–‡æ¡£å·²åˆ›å»ºï¼Œä¼šç»§ç»­æ‰§è¡Œpostä¸­é—´ä»¶çš„hook")])]),t._v(" "),s("blockquote",[s("p",[t._v("post middleware are executed after the hooked method and all of its pre middleware have completed.")])]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"title"}),s("p",[t._v("ä¸‹é¢ä»£ç ä¸­ï¼Œæ‰§è¡Œé¡ºåºä¸ºï¼š init >> validate >> save")]),t._v(" "),s("ul",[s("li",[t._v("init æ–‡æ¡£åˆšè¢«åˆå§‹åŒ–")]),t._v(" "),s("li",[t._v("validate æ ¡éªŒæ•°æ®æ˜¯å¦ç¬¦åˆschemaå®šä¹‰")]),t._v(" "),s("li",[t._v("save æ–‡æ¡£è¢«ä¿å­˜è‡³æ•°æ®åº“ä¸­")])])]),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("schema"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("post")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'init'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("doc")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%s has been initialized from the db'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" doc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nschema"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("post")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'validate'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("doc")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%s has been validated (but not saved yet)'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" doc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nschema"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("post")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'save'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("doc")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%s has been saved'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" doc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("hr"),t._v(" "),s("h2",{attrs:{id:"_2-hook-tips"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-hook-tips"}},[t._v("#")]),t._v(" 2. Hook Tips")]),t._v(" "),s("h3",{attrs:{id:"_2-1-hook-early-return"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-hook-early-return"}},[t._v("#")]),t._v(" 2.1  Hook Early Return")]),t._v(" "),s("blockquote",[s("p",[t._v("å¦‚æœä½¿ç”¨next()ï¼Œåˆ™next()è°ƒç”¨ä¸ä¼šåœæ­¢ä¸­é—´ä»¶å‡½æ•°ä¸­å‰©ä½™çš„ä»£ç æ‰§è¡Œã€‚\nä½¿ç”¨æ—©æœŸè¿”å›æ¨¡å¼å¯ä»¥åœ¨è°ƒç”¨next()æ—¶é˜²æ­¢ä¸­é—´ä»¶å‡½æ•°ä¸­å‰©ä½™çš„ä»£ç ç»§ç»­æ‰§è¡Œã€‚")])]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" schema "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Schema")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nschema"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pre")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'save'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("foo")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'calling next!'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å¦‚æœæ­£å¸¸ä½¿ç”¨next(),è¯¥æ³¨é‡Šä¹‹åçš„ä»£ç ä¹Ÿä¼šç»§ç»­æ‰§è¡Œ")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// do something ...")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h3",{attrs:{id:"_2-2-this-å…³é”®å­—"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-this-å…³é”®å­—"}},[t._v("#")]),t._v(" 2.2  This å…³é”®å­—")]),t._v(" "),s("blockquote",[s("p",[t._v("å¯ä»¥é€šè¿‡ this å…³é”®å­—æ¥è®¿é—® Query å’Œ Update çš„å†…å®¹")])]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" mongoose "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mongoose'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" Schema "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mongoose"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Schema"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" mySchema "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Schema")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" String"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("age")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Number"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nmySchema"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pre")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'findOneAndUpdate'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Accessing the query content:")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" query "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getQuery")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Query:'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" query"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Accessing the update content:")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" update "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getUpdate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Update:'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" update"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Continue the hook chain:")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  \n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// this.setUpdate()?")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" MyModel "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mongoose"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("model")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'MyModel'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mySchema"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// Assuming you have a document with name "John" and age 30 in the collection')]),t._v("\nMyModel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("findOneAndUpdate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"John"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("age")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("31")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" doc")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Document updated here")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"title"}),s("p",[t._v("ğŸ‘€ æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª Mongoose æ¨¡å‹ MyModelï¼Œå¹¶ä¸ºå…¶å®šä¹‰äº†ä¸€ä¸ª findOneAndUpdate çš„ pre hookã€‚åœ¨ pre hook çš„å›è°ƒå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ this.getQuery() å’Œ this.getUpdate() æ–¹æ³•æ¥è®¿é—®æŸ¥è¯¢æ¡ä»¶å’Œæ›´æ–°å†…å®¹ã€‚")]),t._v(" "),s("p",[t._v("éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œhook ä¸­çš„ this å…³é”®å­—æŒ‡å‘å½“å‰çš„ Mongoose Query å¯¹è±¡ã€‚å› æ­¤ï¼Œåœ¨ pre hook ä¸­å¯ä»¥ä½¿ç”¨ this.getQuery() å’Œ this.getUpdate() æ¥è®¿é—®æŸ¥è¯¢æ¡ä»¶å’Œæ›´æ–°å†…å®¹ã€‚")])]),s("hr"),t._v(" "),s("h2",{attrs:{id:"_3-ğŸªè¿œç¨‹-trigger-å’Œ-æœ¬åœ°-hook-çš„åŒºåˆ«"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-ğŸªè¿œç¨‹-trigger-å’Œ-æœ¬åœ°-hook-çš„åŒºåˆ«"}},[t._v("#")]),t._v(" 3. ğŸªè¿œç¨‹ Trigger å’Œ æœ¬åœ° hook çš„åŒºåˆ«")]),t._v(" "),s("blockquote",[s("p",[t._v("MongoDBä¸­çš„é’©å­ï¼ˆHooksï¼‰æ˜¯åœ¨æ•°æ®åº“æ“ä½œæœŸé—´è§¦å‘çš„å›è°ƒå‡½æ•°ã€‚å®ƒä»¬å¯ä»¥ç”¨äºåœ¨ç‰¹å®šäº‹ä»¶å‘ç”Ÿæ—¶æ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘ï¼Œä¾‹å¦‚åœ¨æ’å…¥ã€æ›´æ–°æˆ–åˆ é™¤æ–‡æ¡£ä¹‹å‰æˆ–ä¹‹åæ‰§è¡ŒæŸäº›æ“ä½œã€‚")])]),t._v(" "),s("p",[t._v("é’©å­å¯ä»¥åœ¨æœ¬åœ°æˆ–è¿œç¨‹ä½¿ç”¨ï¼Œå…·ä½“å–å†³äºåº”ç”¨ç¨‹åºçš„æ¶æ„å’Œéœ€æ±‚ã€‚")]),t._v(" "),s("p",[t._v("æ— è®ºæ˜¯æœ¬åœ°è¿˜æ˜¯è¿œç¨‹ï¼Œé’©å­å‡½æ•°éƒ½ä¸æ•°æ®åº“æ“ä½œåœ¨åŒä¸€è¿›ç¨‹ä¸­æ‰§è¡Œã€‚")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("åœ¨æœ¬åœ°é’©å­çš„æƒ…å†µä¸‹ï¼Œé’©å­å‡½æ•°è¢«å®šä¹‰åœ¨åº”ç”¨ç¨‹åºçš„ä»£ç ä¸­ï¼Œç›´æ¥ä¸MongoDBæ•°æ®åº“è¿›è¡Œäº¤äº’ã€‚è¿™æ„å‘³ç€é’©å­å‡½æ•°çš„æ‰§è¡Œå‘ç”Ÿåœ¨åº”ç”¨ç¨‹åºçš„åŒä¸€è¿›ç¨‹ä¸­ï¼Œä¸æ¶‰åŠç½‘ç»œé€šä¿¡ã€‚")])]),t._v(" "),s("li",[s("p",[t._v("åœ¨è¿œç¨‹é’©å­çš„æƒ…å†µä¸‹ï¼Œé’©å­å‡½æ•°è¢«å®šä¹‰åœ¨MongoDBæœåŠ¡å™¨ä¸Šï¼Œå®ƒä»¬æ˜¯ä½œä¸ºæ•°æ®åº“è§¦å‘å™¨ï¼ˆtriggersï¼‰çš„ä¸€éƒ¨åˆ†è¿è¡Œçš„ã€‚å½“ç‰¹å®šäº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒæœåŠ¡å™¨ä¼šè§¦å‘ç›¸åº”çš„é’©å­å‡½æ•°ï¼Œæ‰§è¡Œé¢„å®šä¹‰çš„é€»è¾‘ã€‚è¿œç¨‹é’©å­é€šå¸¸ä¸MongoDB Realmæˆ–å…¶ä»–ç±»ä¼¼çš„æœåŠ¡å™¨ç«¯æ¡†æ¶ä¸€èµ·ä½¿ç”¨ã€‚")])])]),t._v(" "),s("h3",{attrs:{id:"_4-1-mongodb-atlas"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-mongodb-atlas"}},[t._v("#")]),t._v(" 4.1  MongoDB Atlas")]),t._v(" "),s("blockquote",[s("p",[t._v("ongoDB Atlas æ˜¯ MongoDB å…¬å¸æä¾›çš„äº‘æ•°æ®åº“æœåŠ¡ã€‚\nå®ƒæ˜¯åŸºäºäº‘å¹³å°çš„å…¨æ‰˜ç®¡æ•°æ®åº“æœåŠ¡ï¼Œç”¨äºéƒ¨ç½²ã€ç®¡ç†å’Œæ‰©å±• MongoDB æ•°æ®åº“ã€‚\nğŸ‘€ æ³¨å†Œåï¼Œä¸€ä¸ªè´¦å·å¯ä»¥åˆ›å»ºä¸€ä¸ªå…è´¹çš„äº‘æ•°æ®åº“ï¼Œä½†ä¼šè¿‡æœŸï¼Œæ­£å¸¸ä½¿ç”¨å¾—åŠ é’±ğŸ’°")])]),t._v(" "),s("p",[t._v("https://www.mongodb.com/cloud/atlas/register")]),t._v(" "),s("h3",{attrs:{id:"_4-2-trigger-é…ç½®ç•Œé¢"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-trigger-é…ç½®ç•Œé¢"}},[t._v("#")]),t._v(" 4.2  Trigger é…ç½®ç•Œé¢")]),t._v(" "),s("blockquote",[s("p",[t._v("Operation Type : Insert,Update,Delete,Replace\nThis trigger will only execute on these operations.\nTriggerçš„é…ç½®éœ€è¦åœ¨é¡µé¢ä¸Šå®Œæˆ")])]),t._v(" "),s("h3",{attrs:{id:"_4-3-trigger-â˜ï¸-äº‘å‡½æ•°é…ç½®æ¨¡ç‰ˆ"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-trigger-â˜ï¸-äº‘å‡½æ•°é…ç½®æ¨¡ç‰ˆ"}},[t._v("#")]),t._v(" 4.3 Trigger â˜ï¸ äº‘å‡½æ•°é…ç½®æ¨¡ç‰ˆ")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("exports")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("changeEvent")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('/*\n    A Database Trigger will always call a function with a changeEvent.\n    Documentation on ChangeEvents: https://docs.mongodb.com/manual/reference/change-events/\n\n    Access the _id of the changed document:\n    const docId = changeEvent.documentKey._id;\n\n    Access the latest version of the changed document\n    (with Full Document enabled for Insert, Update, and Replace operations):\n    const fullDocument = changeEvent.fullDocument;\n\n    const updateDescription = changeEvent.updateDescription;\n\n    See which fields were changed (if any):\n    if (updateDescription) {\n      const updatedFields = updateDescription.updatedFields; // A document containing updated fields\n    }\n\n    See which fields were removed (if any):\n    if (updateDescription) {\n      const removedFields = updateDescription.removedFields; // An array of removed fields\n    }\n\n    Functions run by Triggers are run as System users and have full access to Services, Functions, and MongoDB Data.\n\n    Access a mongodb service:\n    const collection = context.services.get(<SERVICE_NAME>).db("db_name").collection("coll_name");\n    const doc = collection.findOne({ name: "mongodb" });\n\n    Note: In Atlas Triggers, the service name is defaulted to the cluster name.\n\n    Call other named functions if they are defined in your application:\n    const result = context.functions.execute("function_name", arg1, arg2);\n\n    Access the default http client and execute a GET request:\n    const response = context.http.get({ url: <URL> })\n\n    Learn more about http client here: https://www.mongodb.com/docs/atlas/app-services/functions/context/#std-label-context-http\n  */')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("hr"),t._v(" "),s("h2",{attrs:{id:"_4-trigger-å’Œ-hook-çš„å®ç°åŸç†"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-trigger-å’Œ-hook-çš„å®ç°åŸç†"}},[t._v("#")]),t._v(" 4.  Trigger å’Œ  hook çš„å®ç°åŸç†")]),t._v(" "),s("blockquote",[s("p",[t._v("MongoDBçš„æœ¬åœ°é’©å­å’Œäº‘ç«¯è§¦å‘å™¨åœ¨å®ç°åŸç†ä¸Šæœ‰ä¸€äº›åŒºåˆ«ã€‚")])]),t._v(" "),s("h3",{attrs:{id:"_4-1-æœ¬åœ°-hook-çš„å®ç°åŸç†"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-æœ¬åœ°-hook-çš„å®ç°åŸç†"}},[t._v("#")]),t._v(" 4.1 æœ¬åœ° hook çš„å®ç°åŸç†")]),t._v(" "),s("blockquote",[s("p",[t._v("æœ¬åœ°é’©å­æ˜¯é€šè¿‡åœ¨åº”ç”¨ç¨‹åºä»£ç ä¸­å®šä¹‰çš„å›è°ƒå‡½æ•°å®ç°çš„,å®ç°åŸç†ä¸»è¦æ¶‰åŠä»¥ä¸‹æ­¥éª¤ï¼š")])]),t._v(" "),s("ul",[s("li",[t._v("åœ¨åº”ç”¨ç¨‹åºä¸­æ³¨å†Œé’©å­å‡½æ•°ï¼ŒæŒ‡å®šåœ¨ç‰¹å®šäº‹ä»¶å‘ç”Ÿå‰æˆ–åè¦æ‰§è¡Œçš„é€»è¾‘ã€‚")]),t._v(" "),s("li",[t._v("å½“æ•°æ®åº“æ“ä½œå‘ç”Ÿæ—¶ï¼Œåº”ç”¨ç¨‹åºå°†è°ƒç”¨ç›¸åº”çš„é’©å­å‡½æ•°ï¼Œæ‰§è¡Œé¢„å®šä¹‰çš„é€»è¾‘ã€‚")]),t._v(" "),s("li",[t._v("é’©å­å‡½æ•°çš„æ‰§è¡Œæ˜¯åœ¨åº”ç”¨ç¨‹åºçš„è¿›ç¨‹å†…éƒ¨è¿›è¡Œçš„ï¼Œä¸æ¶‰åŠç½‘ç»œé€šä¿¡ã€‚")])]),t._v(" "),s("h3",{attrs:{id:"_4-2-äº‘ç«¯è§¦å‘å™¨çš„å®ç°åŸç†"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-äº‘ç«¯è§¦å‘å™¨çš„å®ç°åŸç†"}},[t._v("#")]),t._v(" 4.2 äº‘ç«¯è§¦å‘å™¨çš„å®ç°åŸç†")]),t._v(" "),s("blockquote",[s("p",[t._v("äº‘ç«¯è§¦å‘å™¨æ˜¯é€šè¿‡MongoDB Realmæˆ–å…¶ä»–ç±»ä¼¼çš„æœåŠ¡å™¨ç«¯æ¡†æ¶æ¥å®ç°çš„ã€‚è§¦å‘å™¨åœ¨MongoDBæœåŠ¡å™¨ä¸Šå®šä¹‰å’Œæ‰§è¡Œï¼Œå®ƒä»¬ä¸ç‰¹å®šé›†åˆç›¸å…³è”ï¼Œå¹¶åœ¨æ»¡è¶³è§¦å‘æ¡ä»¶æ—¶æ‰§è¡Œé’©å­é€»è¾‘ã€‚äº‘ç«¯è§¦å‘å™¨çš„å®ç°åŸç†ä¸»è¦æ¶‰åŠä»¥ä¸‹æ­¥éª¤ï¼š")])]),t._v(" "),s("ul",[s("li",[t._v("åœ¨MongoDB Realmæˆ–å…¶ä»–æœåŠ¡å™¨ç«¯æ¡†æ¶ä¸­å®šä¹‰è§¦å‘å™¨ï¼Œå¹¶æŒ‡å®šè§¦å‘å™¨è¦ç›‘å¬çš„é›†åˆå’Œè§¦å‘æ¡ä»¶ã€‚")]),t._v(" "),s("li",[t._v("å½“æ»¡è¶³è§¦å‘æ¡ä»¶æ—¶ï¼ŒæœåŠ¡å™¨ä¼šè§¦å‘ç›¸åº”çš„è§¦å‘å™¨ã€‚")]),t._v(" "),s("li",[t._v("è§¦å‘å™¨å†…éƒ¨åŒ…å«äº†é¢„å®šä¹‰çš„é’©å­é€»è¾‘ï¼Œæ ¹æ®å®šä¹‰çš„é€»è¾‘æ‰§è¡Œä¸€ç³»åˆ—æ“ä½œã€‚")]),t._v(" "),s("li",[t._v("äº‘ç«¯è§¦å‘å™¨çš„æ‰§è¡Œå‘ç”Ÿåœ¨æœåŠ¡å™¨ç«¯ï¼Œå¯ä»¥æ¶‰åŠä¸æ•°æ®åº“çš„äº¤äº’å’Œå…¶ä»–ç½‘ç»œé€šä¿¡ã€‚")])]),t._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"title"}),s("p",[t._v("ğŸ‘€ æœ¬åœ°é’©å­æ˜¯åœ¨åº”ç”¨ç¨‹åºä»£ç ä¸­å®šä¹‰å’Œæ‰§è¡Œçš„ï¼Œè€Œäº‘ç«¯è§¦å‘å™¨æ˜¯åœ¨æœåŠ¡å™¨ç«¯å®šä¹‰å’Œæ‰§è¡Œçš„ã€‚")]),t._v(" "),s("ul",[s("li",[t._v("æœ¬åœ°é’©å­ç›´æ¥ä¸æ•°æ®åº“æ“ä½œåœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹å†…éƒ¨äº¤äº’")]),t._v(" "),s("li",[t._v("è€Œäº‘ç«¯è§¦å‘å™¨é€šè¿‡æœåŠ¡å™¨ç«¯æ¡†æ¶ä¸MongoDBæœåŠ¡å™¨è¿›è¡Œäº¤äº’ã€‚")])])]),s("hr"),t._v(" "),s("h2",{attrs:{id:"_5-hook-å®æˆ˜åº”ç”¨"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-hook-å®æˆ˜åº”ç”¨"}},[t._v("#")]),t._v(" 5. Hook å®æˆ˜åº”ç”¨")]),t._v(" "),s("h3",{attrs:{id:"âš ï¸-å‹-å…-æƒ…-è´£-æç¤º"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#âš ï¸-å‹-å…-æƒ…-è´£-æç¤º"}},[t._v("#")]),t._v(" âš ï¸ å‹ï¼ˆå…ï¼‰æƒ…ï¼ˆè´£ï¼‰æç¤º")]),t._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"title"}),s("p",[t._v("ğŸ‘€ åœ¨Mongooseä¸­ï¼Œåœ¨hookï¼ˆé’©å­ï¼‰ä¸­åŠ å…¥ä¸šåŠ¡é€»è¾‘ä»£ç ä¸æ˜¯ç»å¯¹çš„å±é™©ï¼Œä½†æ˜¯éœ€è¦å°å¿ƒä½¿ç”¨ï¼Œå› ä¸ºä¸å½“ä½¿ç”¨å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜å’Œä¸è‰¯å½±å“ã€‚\nHooksæ˜¯åœ¨æ•°æ®åº“æ“ä½œï¼ˆä¾‹å¦‚ä¿å­˜æ–‡æ¡£ã€æ›´æ–°æ–‡æ¡£ã€åˆ é™¤æ–‡æ¡£ç­‰ï¼‰å‰åè§¦å‘çš„å‡½æ•°ï¼Œå…è®¸æ‚¨åœ¨è¿›è¡Œæ•°æ®åº“æ“ä½œä¹‹å‰æˆ–ä¹‹åæ‰§è¡Œä¸€äº›è‡ªå®šä¹‰é€»è¾‘ã€‚å½“åˆç†ä½¿ç”¨æ—¶ï¼Œhookså¯ä»¥å¸®åŠ©æ‚¨åœ¨ä¸ä¿®æ”¹æ•°æ®åº“æ“ä½œçš„æƒ…å†µä¸‹ï¼Œå¢åŠ æˆ–ä¿®æ”¹æ•°æ®ã€æ‰§è¡ŒéªŒè¯ã€å¤„ç†å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ç­‰ã€‚")])]),s("div",{staticClass:"custom-block danger"},[s("p",{staticClass:"title"}),s("p",[t._v("ä»¥ä¸‹æ˜¯åœ¨hooksä¸­åŠ å…¥ä¸šåŠ¡é€»è¾‘æ—¶åº”è€ƒè™‘çš„ä¸€äº›æ½œåœ¨é£é™©ï¼š")]),t._v(" "),s("ol",[s("li",[t._v("æ€§èƒ½é—®é¢˜ï¼šå¦‚æœhookä¸­çš„ä¸šåŠ¡é€»è¾‘å¾ˆå¤æ‚æˆ–éœ€è¦å¤§é‡è®¡ç®—ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®åº“æ“ä½œå˜æ…¢ï¼Œä»è€Œå½±å“æ•´ä½“æ€§èƒ½ã€‚")]),t._v(" "),s("li",[t._v("æ­»å¾ªç¯ï¼šåœ¨hookä¸­æ‰§è¡Œæ•°æ®åº“æ“ä½œï¼ˆä¾‹å¦‚ä¿å­˜æ–‡æ¡£ï¼‰å¯èƒ½å¯¼è‡´æ— é™å¾ªç¯ï¼Œä»è€Œå¼•å‘æ ˆæº¢å‡ºæˆ–å…¶ä»–é—®é¢˜ã€‚")]),t._v(" "),s("li",[t._v("å¼‚å¸¸å¤„ç†ï¼šå¦‚æœåœ¨hookä¸­æ²¡æœ‰é€‚å½“å¤„ç†å¼‚å¸¸ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœªæ•è·çš„é”™è¯¯ï¼Œä½¿åº”ç”¨ç¨‹åºå´©æºƒæˆ–å‡ºç°æœªçŸ¥è¡Œä¸ºã€‚")]),t._v(" "),s("li",[t._v("é’©å­åµŒå¥—ï¼šå½“ä½¿ç”¨å¤šä¸ªé’©å­æ—¶ï¼Œå¯èƒ½ä¼šå‘ç”ŸåµŒå¥—è°ƒç”¨çš„æƒ…å†µï¼Œè¿™å¯èƒ½å¯¼è‡´éš¾ä»¥é¢„æµ‹çš„ç»“æœ")])])]),s("hr"),t._v(" "),s("h3",{attrs:{id:"å®æˆ˜1-åˆ é™¤æ–‡æ¡£çš„åŒæ—¶-åˆ é™¤å·²ä¸Šä¼ çš„é™„ä»¶"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#å®æˆ˜1-åˆ é™¤æ–‡æ¡£çš„åŒæ—¶-åˆ é™¤å·²ä¸Šä¼ çš„é™„ä»¶"}},[t._v("#")]),t._v(" å®æˆ˜1 åˆ é™¤æ–‡æ¡£çš„åŒæ—¶ï¼Œåˆ é™¤å·²ä¸Šä¼ çš„é™„ä»¶")]),t._v(" "),s("blockquote",[s("ol",[s("li",[t._v("Apkæ˜¯mongooseå®šä¹‰çš„schema")]),t._v(" "),s("li",[t._v("æ–‡ä»¶æå‰ä¼šä¸Šä¼ åˆ° config.uploads.path å¯¹åº”çš„æ–‡ä»¶ä¸‹")]),t._v(" "),s("li",[t._v("å•å…ƒæµ‹è¯•ä¸­ï¼ˆprocess.env.NODE_ENV === 'test'ï¼‰ï¼Œä¸ä¼šæ‰§è¡Œå¯¹åº”å†…å®¹")])])]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// åˆ é™¤roomæ—¶ï¼Œå¦‚æœimgæœ‰å†…å®¹ï¼Œéœ€è¦åˆ é™¤å¯¹åº”çš„æ–‡ä»¶")]),t._v("\napkSchema"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pre")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'deleteOne'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("process"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NODE_ENV")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'test'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" original "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" Apk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("findOne")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("_id")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_conditions"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_id "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("original"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("fileName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" url "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("uploads"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("path "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" original"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("fileName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" fileStat "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" fs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("promises"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("stat")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("fileStat"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" fs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("promises"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("unlink")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("blockquote",[s("p",[t._v("ğŸ‘€ ä»¥ä¸Šä»£ç ï¼Œå®ç°äº†åˆ é™¤APKæ—¶ï¼Œä¼šé¡ºå¸¦åˆ é™¤å·²ä¸Šä¼ çš„é™„ä»¶ ğŸ“")])]),t._v(" "),s("h3",{attrs:{id:"å®æˆ˜2-æ›´æ–°booking-åŒæ­¥å‘é€mqtté€šçŸ¥"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#å®æˆ˜2-æ›´æ–°booking-åŒæ­¥å‘é€mqtté€šçŸ¥"}},[t._v("#")]),t._v(" å®æˆ˜2 æ›´æ–°Bookingï¼ŒåŒæ­¥å‘é€mqtté€šçŸ¥")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"title"}),s("p",[t._v("ğŸ‘€ æ­¤å¤„å°†mqtté€šçŸ¥å†™å…¥hookï¼Œå› ä¸ºé¢„è®¢æœ‰ä»»ä½•æ•°æ®æ”¹åŠ¨ï¼Œéƒ½éœ€è¦åŠæ—¶é€šçŸ¥ä¿¡æ¯å±åˆ·æ–°é¢„è®¢æƒ…å†µ\nå¦‚æœä¸å†™å…¥hookä¸­ï¼Œä¼šåœ¨é¡¹ç›®çš„å„å¤„é‡å¤æ’å…¥æ­¤æ®µä»£ç ï¼Œé™ä½ä»£ç çš„å¯è¯»æ€§å’Œæ‰©å±•æ€§")])]),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// é¢„è®¢ã€æ›´æ–°çš„é”™è¯¯æŠ›å‡ºä¸èƒ½åœ¨è¿™é‡Œï¼Œmqtté€šçŸ¥å¯ä»¥")]),t._v("\nbookingSchema"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pre")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'updateOne'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("process"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NODE_ENV")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'test'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" booking "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" Booking"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("findOne")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("_id")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_conditions"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_id "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" devices "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" Device"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("find")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("room")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" booking"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("room "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// è·å–ä¼šè®®å®¤ä¸‹çš„æ‰€æœ‰è®¾å¤‡")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å‘é€mqttæ¶ˆæ¯ï¼Œé€šçŸ¥è®¾å¤‡åˆ·æ–°ä¼šè®®")]),t._v("\n        devices"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("forEach")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("device")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            mqttService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("publishRefreshBooking")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("device"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("code"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h3",{attrs:{id:"å®æˆ˜3-åˆ›å»ºé¢„è®¢æ—¶-æ£€æŸ¥æ•°æ®æ˜¯å¦ç¬¦åˆé¢„æœŸ"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#å®æˆ˜3-åˆ›å»ºé¢„è®¢æ—¶-æ£€æŸ¥æ•°æ®æ˜¯å¦ç¬¦åˆé¢„æœŸ"}},[t._v("#")]),t._v(" å®æˆ˜3 åˆ›å»ºé¢„è®¢æ—¶ï¼Œæ£€æŸ¥æ•°æ®æ˜¯å¦ç¬¦åˆé¢„æœŸ")]),t._v(" "),s("blockquote",[s("p",[t._v("â¬‡ï¸ bookingErrors æ˜¯ è‡ªå®šä¹‰çš„ ServiceErrorï¼ŒåŒ…å«codeå’Œmessage")])]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("code")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("20007")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("data")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("msg")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ä¼šè®®æ—¶é—´å†²çª"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// åˆ›å»ºå¯¹è±¡æ—¶ï¼Œè‡ªåŠ¨å¯»æ‰¾ç§Ÿæˆ·")]),t._v("\nbookingSchema"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pre")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'save'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tenant"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" tenant "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" Tenant"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("findOne")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tenant "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tenant"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" now "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("moment")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("unix")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("beginAt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("beginAt "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" now"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("planBeginAt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("planBeginAt "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("beginAt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("planEndAt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("planEndAt "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("endAt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("beginAt "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" now"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" bookingErrors"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("beginAtLessThanNow")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("throw")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ä¸ å…¨å±€é…ç½®ç›¸å…³ çš„åˆ¤æ–­")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" config "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" Config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("findOne")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("beginAt "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("endAt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" bookingErrors"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("beginAtGreaterThanEndAt")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("throw")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å¼€å§‹æ—¶é—´å¤§äºç»“æŸæ—¶é—´")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("maxBookingDay "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("endAt "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("beginAt "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("maxBookingDay "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("24")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        bookingErrors"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("bookingDayGreaterThanMaxBookingDay")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("fill")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("X")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("maxBookingDay "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("throw")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ä¼šè®®æ—¶é•¿å¤§äºæœ€å¤§é¢„çº¦æ—¶é•¿")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// åˆ¤æ–­æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ä¼šè®®å®¤å’Œåˆ›å»ºäºº")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" room "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" Room"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("findOne")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("_id")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("room "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" creator "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" User"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("findOne")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("_id")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("creator "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("room"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" bookingErrors"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("roomNotFound")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("throw")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("room"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'disable'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" bookingErrors"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("roomDisabled")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("throw")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("creator"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" bookingErrors"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("userNotFound")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("throw")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" validBookings "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" Booking"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("find")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("room")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("room"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("endAt")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("$gte")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("beginAt "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("preTime "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("beginAt")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("$lte")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("endAt "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("preTime "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("state")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" $"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'success'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'start'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("validBookings"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" bookingErrors"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("bookingConflict")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("throw")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("process"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NODE_ENV")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'test'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" devices "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" Device"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("find")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("room")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("room "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// è·å–ä¼šè®®å®¤ä¸‹çš„æ‰€æœ‰è®¾å¤‡")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å‘é€mqttæ¶ˆæ¯ï¼Œé€šçŸ¥è®¾å¤‡åˆ·æ–°ä¼šè®®")]),t._v("\n        devices"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("forEach")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("device")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            mqttService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("publishRefreshBooking")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("device"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("code"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("details",{staticClass:"custom-block details"},[s("summary",[t._v("ä¸Šè¿°ä»£ç ï¼Œé€šè¿‡è°ƒç”¨ save hookï¼Œå®ç°äº†ä»¥ä¸‹éœ€æ±‚ï¼š")]),t._v(" "),s("ol",[s("li",[t._v("å¡«å……ç§Ÿæˆ·id")]),t._v(" "),s("li",[t._v("ä¸èƒ½åˆ›å»ºå½“å‰æ—¶é—´ä¹‹å‰çš„ä¼šè®®")]),t._v(" "),s("li",[t._v("å¼€å§‹æ—¶é—´ä¸èƒ½è¶…è¿‡ç»“æŸæ—¶é—´")]),t._v(" "),s("li",[t._v("é¢„è®¢æ—¶é•¿ä¸èƒ½è¶…è¿‡å…¨å±€é…ç½®ä¸­è®¾ç½®çš„æœ€å¤§é¢„è®¢æ—¶é—´")]),t._v(" "),s("li",[t._v("åˆ¤æ–­ä¼šè®®å®¤æ˜¯å¦å­˜åœ¨")]),t._v(" "),s("li",[t._v("åˆ¤æ–­åˆ›å»ºè€…æ˜¯å¦å­˜åœ¨")]),t._v(" "),s("li",[t._v("åˆ¤æ–­æ˜¯å¦æœ‰ä¼šè®®æ—¶é—´å†²çª")]),t._v(" "),s("li",[t._v("åŒæ­¥å‘é€mqtté€šçŸ¥")])])]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"title"}),s("p",[t._v("âœ… å°½é‡ä¸è¦åœ¨hookä¸­é‡å¤è§¦å‘æ•°æ®åº“æ“ä½œï¼Œè€Œæ˜¯åœ¨hookä¸­åšä¸€äº›ç®€å•çš„éªŒè¯æˆ–æ•°æ®ä¿®æ”¹ã€‚å¯¹äºå¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼Œæœ€å¥½å°†å…¶æ”¾åœ¨å…¶ä»–æ¨¡å—æˆ–æœåŠ¡ä¸­ï¼Œå¹¶ä»hookä¸­è°ƒç”¨è¿™äº›æ¨¡å—ã€‚\nåŒæ—¶ï¼Œç¼–å†™å®Œå–„çš„æµ‹è¯•ä¹Ÿæ˜¯éå¸¸é‡è¦çš„ï¼Œä»¥ç¡®ä¿åœ¨æ·»åŠ hooké€»è¾‘æ—¶ä¸ä¼šå¼•å…¥æ½œåœ¨çš„é—®é¢˜ã€‚\næµ‹è¯•å¯ä»¥å¸®åŠ©æ‚¨éªŒè¯é’©å­çš„è¡Œä¸ºæ˜¯å¦ç¬¦åˆé¢„æœŸï¼Œå¹¶ä¸”åœ¨è¿›è¡Œæ›´æ”¹æ—¶å¯ä»¥æä¾›æ›´å¤§çš„ä¿¡å¿ƒã€‚")])]),s("p",[t._v("æ€»ä¹‹ï¼Œä½¿ç”¨hooksæ¥åŠ å…¥ä¸šåŠ¡é€»è¾‘æ˜¯ä¸€ç§å¸¸è§çš„åšæ³•ï¼Œä½†éœ€è¦è°¨æ…ä½¿ç”¨ï¼Œä»¥é¿å…æ½œåœ¨çš„é—®é¢˜ã€‚\néµå¾ªæœ€ä½³å®è·µï¼Œå¹¶è¿›è¡Œå……åˆ†çš„æµ‹è¯•æ˜¯ç¡®ä¿å®‰å…¨æ€§å’Œç¨³å®šæ€§çš„å…³é”®ã€‚")]),t._v(" "),s("h2",{attrs:{id:"_6-æ€»ç»“"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-æ€»ç»“"}},[t._v("#")]),t._v(" 6. æ€»ç»“")]),t._v(" "),s("p",[t._v("MongoDB Hook æ˜¯ MongoDB æ•°æ®åº“æä¾›çš„ä¸€ç§æ‰©å±•åŠŸèƒ½ï¼Œå®ƒå¯ä»¥åœ¨æ•°æ®åº“æ“ä½œå‰åæ‰§è¡Œé¢å¤–çš„ä»£ç æˆ–æ“ä½œã€‚\né€šè¿‡ä½¿ç”¨ MongoDB Hookï¼Œæ‚¨å¯ä»¥ä¸ºæ•°æ®åº“æ“ä½œæ·»åŠ è‡ªå®šä¹‰é€»è¾‘ï¼Œæé«˜åº”ç”¨ç¨‹åºçš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ã€‚\nMongoDB Hook å¯ä»¥åº”ç”¨äº CRUD æ“ä½œçš„å…¨è¿‡ç¨‹ï¼Œå¦‚æŸ¥è¯¢ã€æ’å…¥ã€æ›´æ–°å’Œåˆ é™¤ç­‰ã€‚")]),t._v(" "),s("p",[t._v("MongoDB Atlas æ˜¯ MongoDB å…¬å¸æä¾›çš„äº‘æ•°æ®åº“æœåŠ¡ã€‚å®ƒæ˜¯åŸºäºäº‘å¹³å°çš„å…¨æ‰˜ç®¡æ•°æ®åº“æœåŠ¡\nMongoDB Atlas ç®€åŒ–äº†åœ¨äº‘ä¸­ç®¡ç† MongoDB æ•°æ®åº“çš„è¿‡ç¨‹ï¼Œä¸ºæ‚¨çš„æ•°æ®å­˜å‚¨å’Œç®¡ç†éœ€æ±‚æä¾›å¯æ‰©å±•ä¸”å®‰å…¨çš„è§£å†³æ–¹æ¡ˆ")])])}),[],!1,null,null,null);s.default=e.exports}}]);