<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Mongodb hook | Sapphire611</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content=":::tip
ORM: Mongoose">
    <meta name="twitter:title" content="Mongodb hook">
    <meta name="twitter:description" content=":::tip
ORM: Mongoose">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:url" content="https://sapphire611.github.io/backend/mongodb/hook/">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Mongodb hook">
    <meta property="og:description" content=":::tip
ORM: Mongoose">
    <meta property="og:url" content="https://sapphire611.github.io/backend/mongodb/hook/">
    <meta property="og:site_name" content="Sapphire611">
    <meta property="article:published_time" content="2023-8-29">
    <meta property="article:tag" content="mongodb">
    <meta itemprop="name" content="Mongodb hook">
    <meta itemprop="description" content=":::tip
ORM: Mongoose">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.1645be0a.css" as="style"><link rel="preload" href="/assets/js/app.be8121bb.js" as="script"><link rel="preload" href="/assets/js/7.1077a71e.js" as="script"><link rel="preload" href="/assets/js/2.e054aee5.js" as="script"><link rel="preload" href="/assets/js/1.388f40f4.js" as="script"><link rel="preload" href="/assets/js/47.197a6718.js" as="script"><link rel="prefetch" href="/assets/js/10.1ef88b34.js"><link rel="prefetch" href="/assets/js/11.3219b221.js"><link rel="prefetch" href="/assets/js/14.122bf10b.js"><link rel="prefetch" href="/assets/js/15.1262aa08.js"><link rel="prefetch" href="/assets/js/16.b5a55116.js"><link rel="prefetch" href="/assets/js/17.d7d33446.js"><link rel="prefetch" href="/assets/js/18.70ed19a9.js"><link rel="prefetch" href="/assets/js/19.0ac15c9e.js"><link rel="prefetch" href="/assets/js/20.1d7e4bf1.js"><link rel="prefetch" href="/assets/js/21.5c0debce.js"><link rel="prefetch" href="/assets/js/22.a944dd57.js"><link rel="prefetch" href="/assets/js/23.09c42f75.js"><link rel="prefetch" href="/assets/js/24.8b60b5ca.js"><link rel="prefetch" href="/assets/js/25.a359b136.js"><link rel="prefetch" href="/assets/js/26.de225473.js"><link rel="prefetch" href="/assets/js/27.dc68676b.js"><link rel="prefetch" href="/assets/js/28.f4658075.js"><link rel="prefetch" href="/assets/js/29.da1a9929.js"><link rel="prefetch" href="/assets/js/3.54a6bf28.js"><link rel="prefetch" href="/assets/js/30.82726e5c.js"><link rel="prefetch" href="/assets/js/31.09d56f42.js"><link rel="prefetch" href="/assets/js/32.167240b6.js"><link rel="prefetch" href="/assets/js/33.42cd2ef9.js"><link rel="prefetch" href="/assets/js/34.d4a0f090.js"><link rel="prefetch" href="/assets/js/35.b4fe8237.js"><link rel="prefetch" href="/assets/js/36.a4180f84.js"><link rel="prefetch" href="/assets/js/37.f266f07f.js"><link rel="prefetch" href="/assets/js/38.d8d33f4c.js"><link rel="prefetch" href="/assets/js/39.2cefd7c9.js"><link rel="prefetch" href="/assets/js/4.43501b1c.js"><link rel="prefetch" href="/assets/js/40.5442eeda.js"><link rel="prefetch" href="/assets/js/41.1d3b7390.js"><link rel="prefetch" href="/assets/js/42.20709029.js"><link rel="prefetch" href="/assets/js/43.a06827f8.js"><link rel="prefetch" href="/assets/js/44.1287c956.js"><link rel="prefetch" href="/assets/js/45.ca7249bb.js"><link rel="prefetch" href="/assets/js/46.aefcb29b.js"><link rel="prefetch" href="/assets/js/48.08afcf0d.js"><link rel="prefetch" href="/assets/js/49.75447eaa.js"><link rel="prefetch" href="/assets/js/5.cc49fd84.js"><link rel="prefetch" href="/assets/js/50.4a392cbf.js"><link rel="prefetch" href="/assets/js/51.c1f82fd8.js"><link rel="prefetch" href="/assets/js/52.054a0fde.js"><link rel="prefetch" href="/assets/js/53.1a90408c.js"><link rel="prefetch" href="/assets/js/54.cdbc2d0d.js"><link rel="prefetch" href="/assets/js/55.b0127b29.js"><link rel="prefetch" href="/assets/js/56.66dc7345.js"><link rel="prefetch" href="/assets/js/57.28db5c79.js"><link rel="prefetch" href="/assets/js/58.f0c9e314.js"><link rel="prefetch" href="/assets/js/59.79d145fc.js"><link rel="prefetch" href="/assets/js/6.fed4eafd.js"><link rel="prefetch" href="/assets/js/60.f5c53d76.js"><link rel="prefetch" href="/assets/js/61.77920e93.js"><link rel="prefetch" href="/assets/js/62.e0e0ee08.js"><link rel="prefetch" href="/assets/js/63.0c727790.js"><link rel="prefetch" href="/assets/js/64.5940fa83.js"><link rel="prefetch" href="/assets/js/65.e8fd4bd1.js"><link rel="prefetch" href="/assets/js/66.3b9b8e85.js"><link rel="prefetch" href="/assets/js/67.d66434c6.js"><link rel="prefetch" href="/assets/js/68.192c1263.js"><link rel="prefetch" href="/assets/js/69.bd0da472.js"><link rel="prefetch" href="/assets/js/70.f4cfe08f.js"><link rel="prefetch" href="/assets/js/71.fb4cb7f7.js"><link rel="prefetch" href="/assets/js/72.62ebbc19.js"><link rel="prefetch" href="/assets/js/73.00ba4409.js"><link rel="prefetch" href="/assets/js/74.6dd6de9b.js"><link rel="prefetch" href="/assets/js/75.5ce2eb79.js"><link rel="prefetch" href="/assets/js/76.04acce53.js"><link rel="prefetch" href="/assets/js/77.d2bc67f5.js"><link rel="prefetch" href="/assets/js/78.72bbeb04.js"><link rel="prefetch" href="/assets/js/79.a57a27a5.js"><link rel="prefetch" href="/assets/js/8.610579ad.js"><link rel="prefetch" href="/assets/js/80.c54ba506.js"><link rel="prefetch" href="/assets/js/81.188d8acf.js"><link rel="prefetch" href="/assets/js/82.2a35cc94.js"><link rel="prefetch" href="/assets/js/83.cfbdce20.js"><link rel="prefetch" href="/assets/js/84.ff2733ee.js"><link rel="prefetch" href="/assets/js/85.39ede0ff.js"><link rel="prefetch" href="/assets/js/86.c7ae87b4.js"><link rel="prefetch" href="/assets/js/87.37650ce9.js"><link rel="prefetch" href="/assets/js/88.538166d3.js"><link rel="prefetch" href="/assets/js/89.0b6f2265.js"><link rel="prefetch" href="/assets/js/9.fc56f4a9.js"><link rel="prefetch" href="/assets/js/90.eb7c64bd.js"><link rel="prefetch" href="/assets/js/91.e5d5138a.js"><link rel="prefetch" href="/assets/js/92.9e38e326.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.1db7383c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1645be0a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Sapphire611</h3> <p class="description" data-v-59e6cb88>æ„Ÿè°¢æ¥è®¿ğŸ™ </p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
        Â Â 
        <span data-v-59e6cb88>2021 - </span>
        2025
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.jpg" alt="Sapphire611" class="logo"> <span class="site-name">Sapphire611</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/aboutMe/" class="nav-link"><i class="info"></i>
  About Me
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/elasticSearch/" class="nav-link"><i class="undefined"></i>
  elasticSearch
</a></li><li class="dropdown-item"><!----> <a href="/categories/Me/" class="nav-link"><i class="undefined"></i>
  Me
</a></li><li class="dropdown-item"><!----> <a href="/categories/archietcture/" class="nav-link"><i class="undefined"></i>
  archietcture
</a></li><li class="dropdown-item"><!----> <a href="/categories/Backend/" class="nav-link"><i class="undefined"></i>
  Backend
</a></li><li class="dropdown-item"><!----> <a href="/categories/mongodb/" class="nav-link"><i class="undefined"></i>
  mongodb
</a></li><li class="dropdown-item"><!----> <a href="/categories/shard/" class="nav-link"><i class="undefined"></i>
  shard
</a></li><li class="dropdown-item"><!----> <a href="/categories/Frontend/" class="nav-link"><i class="undefined"></i>
  Frontend
</a></li><li class="dropdown-item"><!----> <a href="/categories/Algorithm/" class="nav-link"><i class="undefined"></i>
  Algorithm
</a></li><li class="dropdown-item"><!----> <a href="/categories/interview/" class="nav-link"><i class="undefined"></i>
  interview
</a></li><li class="dropdown-item"><!----> <a href="/categories/postgres/" class="nav-link"><i class="undefined"></i>
  postgres
</a></li><li class="dropdown-item"><!----> <a href="/categories/database/" class="nav-link"><i class="undefined"></i>
  database
</a></li><li class="dropdown-item"><!----> <a href="/categories/backend/" class="nav-link"><i class="undefined"></i>
  backend
</a></li><li class="dropdown-item"><!----> <a href="/categories/Javascript/" class="nav-link"><i class="undefined"></i>
  Javascript
</a></li><li class="dropdown-item"><!----> <a href="/categories/Certificate/" class="nav-link"><i class="undefined"></i>
  Certificate
</a></li><li class="dropdown-item"><!----> <a href="/categories/Other/" class="nav-link"><i class="undefined"></i>
  Other
</a></li><li class="dropdown-item"><!----> <a href="/categories/Deploy/" class="nav-link"><i class="undefined"></i>
  Deploy
</a></li><li class="dropdown-item"><!----> <a href="/categories/graphql/" class="nav-link"><i class="undefined"></i>
  graphql
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div> <a href="https://github.com/Sapphire611/vuepress-sapphire611" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/img/logo.jpg" alt="author-avatar" class="personal-img" data-v-1fad0c41> <!----> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>53</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>33</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41><li class="social-item" data-v-1fad0c41><i class="iconfont reco-github" style="color:#3498db;" data-v-1fad0c41></i></li><li class="social-item" data-v-1fad0c41><i class="iconfont reco-bilibili" style="color:#abbd81;" data-v-1fad0c41></i></li><li class="social-item" data-v-1fad0c41><i class="iconfont reco-zhihu" style="color:#3498db;" data-v-1fad0c41></i></li></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/aboutMe/" class="nav-link"><i class="info"></i>
  About Me
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/elasticSearch/" class="nav-link"><i class="undefined"></i>
  elasticSearch
</a></li><li class="dropdown-item"><!----> <a href="/categories/Me/" class="nav-link"><i class="undefined"></i>
  Me
</a></li><li class="dropdown-item"><!----> <a href="/categories/archietcture/" class="nav-link"><i class="undefined"></i>
  archietcture
</a></li><li class="dropdown-item"><!----> <a href="/categories/Backend/" class="nav-link"><i class="undefined"></i>
  Backend
</a></li><li class="dropdown-item"><!----> <a href="/categories/mongodb/" class="nav-link"><i class="undefined"></i>
  mongodb
</a></li><li class="dropdown-item"><!----> <a href="/categories/shard/" class="nav-link"><i class="undefined"></i>
  shard
</a></li><li class="dropdown-item"><!----> <a href="/categories/Frontend/" class="nav-link"><i class="undefined"></i>
  Frontend
</a></li><li class="dropdown-item"><!----> <a href="/categories/Algorithm/" class="nav-link"><i class="undefined"></i>
  Algorithm
</a></li><li class="dropdown-item"><!----> <a href="/categories/interview/" class="nav-link"><i class="undefined"></i>
  interview
</a></li><li class="dropdown-item"><!----> <a href="/categories/postgres/" class="nav-link"><i class="undefined"></i>
  postgres
</a></li><li class="dropdown-item"><!----> <a href="/categories/database/" class="nav-link"><i class="undefined"></i>
  database
</a></li><li class="dropdown-item"><!----> <a href="/categories/backend/" class="nav-link"><i class="undefined"></i>
  backend
</a></li><li class="dropdown-item"><!----> <a href="/categories/Javascript/" class="nav-link"><i class="undefined"></i>
  Javascript
</a></li><li class="dropdown-item"><!----> <a href="/categories/Certificate/" class="nav-link"><i class="undefined"></i>
  Certificate
</a></li><li class="dropdown-item"><!----> <a href="/categories/Other/" class="nav-link"><i class="undefined"></i>
  Other
</a></li><li class="dropdown-item"><!----> <a href="/categories/Deploy/" class="nav-link"><i class="undefined"></i>
  Deploy
</a></li><li class="dropdown-item"><!----> <a href="/categories/graphql/" class="nav-link"><i class="undefined"></i>
  graphql
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div> <a href="https://github.com/Sapphire611/vuepress-sapphire611" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Mongodb hook</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
        Â Â 
        <span data-v-59e6cb88>2021 - </span>
        2025
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">Mongodb hook</h1> <div data-v-8a445198><!----> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>8/29/2023</span></i> <i class="iconfont reco-eye" data-v-8a445198><span id="/backend/mongodb/hook/" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-8a445198><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>mongodb</span></i></div></div> <div class="theme-reco-content content__default"><div class="custom-block tip"><p class="title"></p><p>ORM: Mongoose</p> <p>Reference: https://mongoosejs.com/docs/middleware.html</p> <p>ä»£ç å¯ä»¥å¤åˆ¶åˆ°æœ¬åœ°ï¼Œå®‰è£…ä¾èµ–åç›´æ¥è¿è¡Œï½</p></div><h2 id="_1-å‰è¨€"><a href="#_1-å‰è¨€" class="header-anchor">#</a> 1. å‰è¨€</h2> <blockquote><p>MongoDBçš„Hookç›‘å¬æ˜¯ä¸€ç§åœ¨æ•°æ®åº“æ“ä½œå‰åæ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘çš„åŠŸèƒ½,
ä¾‹å¦‚åœ¨æ’å…¥æ•°æ®å‰å¯¹æ•°æ®è¿›è¡ŒåŠ å·¥, åœ¨åˆ é™¤æ•°æ®åå¯¹æ•°æ®è¿›è¡Œæ¸…ç†ç­‰ç­‰</p></blockquote> <blockquote><p>å…¶ä¸­preHookä»£è¡¨åœ¨æ“ä½œå‰æ‰§è¡Œ, postHookä»£è¡¨åœ¨æ“ä½œåæ‰§è¡Œ</p></blockquote> <div class="custom-block tip"><p class="title"></p><p>ğŸ‘€ é€‚ç”¨åœºæ™¯</p> <ol><li>å®‰å…¨æ€§æ§åˆ¶ï¼šæ‚¨å¯ä»¥ä½¿ç”¨ MongoDB Hook æ¥å®ç°å®‰å…¨æ€§æ§åˆ¶ï¼Œä¾‹å¦‚åœ¨æŸ¥è¯¢æˆ–æ›´æ–°æ“ä½œå‰éªŒè¯ç”¨æˆ·çš„æƒé™ã€‚</li> <li>æ•°æ®è½¬æ¢å’Œæ ¼å¼åŒ–ï¼šæ‚¨å¯ä»¥åœ¨ MongoDB Hook ä¸­ç¼–å†™ä»£ç ï¼Œå°†æ•°æ®è¿›è¡Œæ ¼å¼åŒ–æˆ–è½¬æ¢ï¼Œä»¥æ»¡è¶³åº”ç”¨ç¨‹åºçš„éœ€æ±‚ã€‚</li> <li>å®¡è®¡æ—¥å¿—ï¼šé€šè¿‡ä½¿ç”¨ MongoDB Hookï¼Œæ‚¨å¯ä»¥è®°å½•æ•°æ®åº“æ“ä½œçš„ç›¸å…³ä¿¡æ¯ã€ç±»å‹ã€æ‰§è¡Œæ—¶é—´å’Œç»“æœç­‰ã€‚</li> <li>æ‰©å±•ç´¢å¼•ï¼šæ‚¨å¯ä»¥ä½¿ç”¨ MongoDB Hook åˆ›å»ºè‡ªå®šä¹‰ç´¢å¼•ï¼Œä»¥æ»¡è¶³ç‰¹å®šçš„æŸ¥è¯¢éœ€æ±‚ã€‚</li> <li>æ•°æ®å¡«å……å’Œä¿®æ­£ï¼šåœ¨æ’å…¥æˆ–æ›´æ–°æ“ä½œåï¼Œå¯ä»¥æ·»åŠ é¢å¤–çš„é€»è¾‘ï¼Œä¾‹å¦‚å¡«å……é»˜è®¤å€¼ã€æ‰§è¡Œæ ¡éªŒç­‰ã€‚</li></ol></div><hr> <h3 id="ç¤ºä¾‹1-ç®€å•ä½¿ç”¨"><a href="#ç¤ºä¾‹1-ç®€å•ä½¿ç”¨" class="header-anchor">#</a> ç¤ºä¾‹1 ç®€å•ä½¿ç”¨</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// è¿æ¥MongoDBæ•°æ®åº“</span>
mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'mongodb://localhost:27017/test'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> 
    <span class="token literal-property property">useNewUrlParser</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">useUnifiedTopology</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// å®šä¹‰Useræ¨¡å‹  </span>
<span class="token keyword">const</span> UserSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token literal-property property">age</span><span class="token operator">:</span> Number<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// å®šä¹‰prehook  </span>
UserSchema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åœ¨ä¿å­˜æ–‡æ¡£ä¹‹å‰æ‰§è¡Œä¸€äº›æ“ä½œï¼Œä¾‹å¦‚ç”Ÿæˆå”¯ä¸€çš„IDæˆ–æ·»åŠ æ—¶é—´æˆ³ç­‰  </span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Pre-save hook called'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// å®šä¹‰posthook  </span>
UserSchema<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åœ¨ä¿å­˜æ–‡æ¡£ä¹‹åæ‰§è¡Œä¸€äº›æ“ä½œï¼Œä¾‹å¦‚å‘é€é‚®ä»¶æˆ–è®°å½•æ—¥å¿—ç­‰  </span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Post-save hook called'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¿™é‡Œä¸éœ€è¦next()</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> User <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">,</span> UserSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// åˆ›å»ºä¸€ä¸ªæ–°Userå¹¶ä¿å­˜  </span>
<span class="token keyword">const</span> newUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'John Doe'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

newUser<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>è¾“å‡º:</p> <div class="language-js extra-class"><pre class="language-js"><code>Pre<span class="token operator">-</span>save hook called
Post<span class="token operator">-</span>save hook called
</code></pre></div><hr> <div class="custom-block tip"><p class="title"></p><p>ğŸ‘€ åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªUseræ¨¡å‹ï¼Œå¹¶åœ¨å…¶ä¸Šå®šä¹‰äº†ä¸¤ä¸ªé’©å­ï¼šä¸€ä¸ªprehookå’Œä¸€ä¸ªposthookã€‚
prehookå°†åœ¨ä¿å­˜æ–‡æ¡£ä¹‹å‰è°ƒç”¨ï¼Œè€Œposthookå°†åœ¨ä¿å­˜æ–‡æ¡£ä¹‹åè°ƒç”¨ã€‚
æˆ‘ä»¬å¯ä»¥åœ¨prehookä¸­æ‰§è¡Œä¸€äº›å‰ç½®é€»è¾‘ï¼Œåœ¨posthookä¸­æ‰§è¡Œä¸€äº›åç½®é€»è¾‘ï¼Œ
åˆ›å»ºæ–°çš„å®ä¾‹å¹¶ä¿å­˜åˆ°æ•°æ®åº“ä¸­æ—¶ï¼Œä¼šåŒæ—¶è§¦å‘é’©å­å‡½æ•°ã€‚</p></div><h3 id="ç¤ºä¾‹2-æ£€æŸ¥bookingçš„å¼€å§‹ç»“æŸæ—¶é—´"><a href="#ç¤ºä¾‹2-æ£€æŸ¥bookingçš„å¼€å§‹ç»“æŸæ—¶é—´" class="header-anchor">#</a> ç¤ºä¾‹2 æ£€æŸ¥Bookingçš„å¼€å§‹ç»“æŸæ—¶é—´</h3> <blockquote><p>å‡è®¾æœ‰ä¸€ä¸ªé¢„è®¢ï¼Œåˆ›å»ºé¢„è®¢çš„æ—¶å€™éœ€è¦ä¿è¯æ•°æ®æ»¡è¶³: beginAt &lt; endAt ï¼ˆä¼šè®®å¼€å§‹æ—¶é—´å¿…é¡»å°äºä¼šè®®ç»“æŸæ—¶é—´ï¼‰</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// è¿æ¥MongoDBæ•°æ®åº“</span>
mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'mongodb://localhost:27017/test'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">useNewUrlParser</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">useUnifiedTopology</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// å®šä¹‰Useræ¨¡å‹  </span>
<span class="token keyword">const</span> BookingSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token literal-property property">beginAt</span><span class="token operator">:</span> Number<span class="token punctuation">,</span>
    <span class="token literal-property property">endAt</span><span class="token operator">:</span> Number<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// å®šä¹‰prehook  </span>
BookingSchema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.log(this)</span>
    <span class="token comment">// å¦‚æœbeginAtå¤§äºendAtï¼Œåˆ™æŠ¥é”™</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beginAt <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>endAt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'beginAt must be less than endAt'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æˆ–è€…ï¼šthrow Error('beginAt must be less than endAt')</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Booking <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Booking'</span><span class="token punctuation">,</span> BookingSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// åˆ›å»ºä¸€ä¸ªæ–°Bookingå¹¶ä¿å­˜  </span>
<span class="token keyword">const</span> booking <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Booking</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'booking'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">beginAt</span><span class="token operator">:</span> <span class="token number">321</span><span class="token punctuation">,</span>
    <span class="token literal-property property">endAt</span><span class="token operator">:</span> <span class="token number">123</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

booking<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>ğŸ‘€ ä»¥ä¸Šä»£ç å¯ä»¥è¿è¡Œï¼Œé¢„æœŸç»“æœæ˜¯æŠ›å‡º beginAt must be less than endAtçš„é”™è¯¯</p></blockquote> <h3 id="post-middleware-å¯¹åº”æ‰§è¡Œé¡ºåº"><a href="#post-middleware-å¯¹åº”æ‰§è¡Œé¡ºåº" class="header-anchor">#</a> * Post middleware å¯¹åº”æ‰§è¡Œé¡ºåº</h3> <ul><li>æŒ‚é’©æ–¹æ³•åï¼Œä¸­é—´ä»¶å°†æ‰§è¡Œï¼Œåœ¨å…¶æ‰€æœ‰preä¸­é—´ä»¶éƒ½å·²å®Œæˆåï¼Œæ–‡æ¡£å·²åˆ›å»ºï¼Œä¼šç»§ç»­æ‰§è¡Œpostä¸­é—´ä»¶çš„hook</li></ul> <blockquote><p>post middleware are executed after the hooked method and all of its pre middleware have completed.</p></blockquote> <div class="custom-block tip"><p class="title"></p><p>ä¸‹é¢ä»£ç ä¸­ï¼Œæ‰§è¡Œé¡ºåºä¸ºï¼š init &gt;&gt; validate &gt;&gt; save</p> <ul><li>init æ–‡æ¡£åˆšè¢«åˆå§‹åŒ–</li> <li>validate æ ¡éªŒæ•°æ®æ˜¯å¦ç¬¦åˆschemaå®šä¹‰</li> <li>save æ–‡æ¡£è¢«ä¿å­˜è‡³æ•°æ®åº“ä¸­</li></ul></div><div class="language-js extra-class"><pre class="language-js"><code>schema<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'init'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'%s has been initialized from the db'</span><span class="token punctuation">,</span> doc<span class="token punctuation">.</span>_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
schema<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'validate'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'%s has been validated (but not saved yet)'</span><span class="token punctuation">,</span> doc<span class="token punctuation">.</span>_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
schema<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'%s has been saved'</span><span class="token punctuation">,</span> doc<span class="token punctuation">.</span>_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><hr> <h2 id="_2-hook-tips"><a href="#_2-hook-tips" class="header-anchor">#</a> 2. Hook Tips</h2> <h3 id="_2-1-hook-early-return"><a href="#_2-1-hook-early-return" class="header-anchor">#</a> 2.1  Hook Early Return</h3> <blockquote><p>å¦‚æœä½¿ç”¨next()ï¼Œåˆ™next()è°ƒç”¨ä¸ä¼šåœæ­¢ä¸­é—´ä»¶å‡½æ•°ä¸­å‰©ä½™çš„ä»£ç æ‰§è¡Œã€‚
ä½¿ç”¨æ—©æœŸè¿”å›æ¨¡å¼å¯ä»¥åœ¨è°ƒç”¨next()æ—¶é˜²æ­¢ä¸­é—´ä»¶å‡½æ•°ä¸­å‰©ä½™çš„ä»£ç ç»§ç»­æ‰§è¡Œã€‚</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
schema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'calling next!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å¦‚æœæ­£å¸¸ä½¿ç”¨next(),è¯¥æ³¨é‡Šä¹‹åçš„ä»£ç ä¹Ÿä¼šç»§ç»­æ‰§è¡Œ</span>
  <span class="token comment">// do something ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_2-2-this-å…³é”®å­—"><a href="#_2-2-this-å…³é”®å­—" class="header-anchor">#</a> 2.2  This å…³é”®å­—</h3> <blockquote><p>å¯ä»¥é€šè¿‡ this å…³é”®å­—æ¥è®¿é—® Query å’Œ Update çš„å†…å®¹</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Schema <span class="token operator">=</span> mongoose<span class="token punctuation">.</span>Schema<span class="token punctuation">;</span>

<span class="token keyword">const</span> mySchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> String<span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> Number<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

mySchema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'findOneAndUpdate'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Accessing the query content:</span>
  <span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Query:'</span><span class="token punctuation">,</span> query<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Accessing the update content:</span>
  <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Update:'</span><span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Continue the hook chain:</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// this.setUpdate()?</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> MyModel <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'MyModel'</span><span class="token punctuation">,</span> mySchema<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Assuming you have a document with name &quot;John&quot; and age 30 in the collection</span>
MyModel<span class="token punctuation">.</span><span class="token function">findOneAndUpdate</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;John&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">31</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> doc</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Document updated here</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-block tip"><p class="title"></p><p>ğŸ‘€ æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª Mongoose æ¨¡å‹ MyModelï¼Œå¹¶ä¸ºå…¶å®šä¹‰äº†ä¸€ä¸ª findOneAndUpdate çš„ pre hookã€‚åœ¨ pre hook çš„å›è°ƒå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ this.getQuery() å’Œ this.getUpdate() æ–¹æ³•æ¥è®¿é—®æŸ¥è¯¢æ¡ä»¶å’Œæ›´æ–°å†…å®¹ã€‚</p> <p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œhook ä¸­çš„ this å…³é”®å­—æŒ‡å‘å½“å‰çš„ Mongoose Query å¯¹è±¡ã€‚å› æ­¤ï¼Œåœ¨ pre hook ä¸­å¯ä»¥ä½¿ç”¨ this.getQuery() å’Œ this.getUpdate() æ¥è®¿é—®æŸ¥è¯¢æ¡ä»¶å’Œæ›´æ–°å†…å®¹ã€‚</p></div><hr> <h2 id="_3-ğŸªè¿œç¨‹-trigger-å’Œ-æœ¬åœ°-hook-çš„åŒºåˆ«"><a href="#_3-ğŸªè¿œç¨‹-trigger-å’Œ-æœ¬åœ°-hook-çš„åŒºåˆ«" class="header-anchor">#</a> 3. ğŸªè¿œç¨‹ Trigger å’Œ æœ¬åœ° hook çš„åŒºåˆ«</h2> <blockquote><p>MongoDBä¸­çš„é’©å­ï¼ˆHooksï¼‰æ˜¯åœ¨æ•°æ®åº“æ“ä½œæœŸé—´è§¦å‘çš„å›è°ƒå‡½æ•°ã€‚å®ƒä»¬å¯ä»¥ç”¨äºåœ¨ç‰¹å®šäº‹ä»¶å‘ç”Ÿæ—¶æ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘ï¼Œä¾‹å¦‚åœ¨æ’å…¥ã€æ›´æ–°æˆ–åˆ é™¤æ–‡æ¡£ä¹‹å‰æˆ–ä¹‹åæ‰§è¡ŒæŸäº›æ“ä½œã€‚</p></blockquote> <p>é’©å­å¯ä»¥åœ¨æœ¬åœ°æˆ–è¿œç¨‹ä½¿ç”¨ï¼Œå…·ä½“å–å†³äºåº”ç”¨ç¨‹åºçš„æ¶æ„å’Œéœ€æ±‚ã€‚</p> <p>æ— è®ºæ˜¯æœ¬åœ°è¿˜æ˜¯è¿œç¨‹ï¼Œé’©å­å‡½æ•°éƒ½ä¸æ•°æ®åº“æ“ä½œåœ¨åŒä¸€è¿›ç¨‹ä¸­æ‰§è¡Œã€‚</p> <ul><li><p>åœ¨æœ¬åœ°é’©å­çš„æƒ…å†µä¸‹ï¼Œé’©å­å‡½æ•°è¢«å®šä¹‰åœ¨åº”ç”¨ç¨‹åºçš„ä»£ç ä¸­ï¼Œç›´æ¥ä¸MongoDBæ•°æ®åº“è¿›è¡Œäº¤äº’ã€‚è¿™æ„å‘³ç€é’©å­å‡½æ•°çš„æ‰§è¡Œå‘ç”Ÿåœ¨åº”ç”¨ç¨‹åºçš„åŒä¸€è¿›ç¨‹ä¸­ï¼Œä¸æ¶‰åŠç½‘ç»œé€šä¿¡ã€‚</p></li> <li><p>åœ¨è¿œç¨‹é’©å­çš„æƒ…å†µä¸‹ï¼Œé’©å­å‡½æ•°è¢«å®šä¹‰åœ¨MongoDBæœåŠ¡å™¨ä¸Šï¼Œå®ƒä»¬æ˜¯ä½œä¸ºæ•°æ®åº“è§¦å‘å™¨ï¼ˆtriggersï¼‰çš„ä¸€éƒ¨åˆ†è¿è¡Œçš„ã€‚å½“ç‰¹å®šäº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒæœåŠ¡å™¨ä¼šè§¦å‘ç›¸åº”çš„é’©å­å‡½æ•°ï¼Œæ‰§è¡Œé¢„å®šä¹‰çš„é€»è¾‘ã€‚è¿œç¨‹é’©å­é€šå¸¸ä¸MongoDB Realmæˆ–å…¶ä»–ç±»ä¼¼çš„æœåŠ¡å™¨ç«¯æ¡†æ¶ä¸€èµ·ä½¿ç”¨ã€‚</p></li></ul> <h3 id="_4-1-mongodb-atlas"><a href="#_4-1-mongodb-atlas" class="header-anchor">#</a> 4.1  MongoDB Atlas</h3> <blockquote><p>ongoDB Atlas æ˜¯ MongoDB å…¬å¸æä¾›çš„äº‘æ•°æ®åº“æœåŠ¡ã€‚
å®ƒæ˜¯åŸºäºäº‘å¹³å°çš„å…¨æ‰˜ç®¡æ•°æ®åº“æœåŠ¡ï¼Œç”¨äºéƒ¨ç½²ã€ç®¡ç†å’Œæ‰©å±• MongoDB æ•°æ®åº“ã€‚
ğŸ‘€ æ³¨å†Œåï¼Œä¸€ä¸ªè´¦å·å¯ä»¥åˆ›å»ºä¸€ä¸ªå…è´¹çš„äº‘æ•°æ®åº“ï¼Œä½†ä¼šè¿‡æœŸï¼Œæ­£å¸¸ä½¿ç”¨å¾—åŠ é’±ğŸ’°</p></blockquote> <p>https://www.mongodb.com/cloud/atlas/register</p> <h3 id="_4-2-trigger-é…ç½®ç•Œé¢"><a href="#_4-2-trigger-é…ç½®ç•Œé¢" class="header-anchor">#</a> 4.2  Trigger é…ç½®ç•Œé¢</h3> <blockquote><p>Operation Type : Insert,Update,Delete,Replace
This trigger will only execute on these operations.
Triggerçš„é…ç½®éœ€è¦åœ¨é¡µé¢ä¸Šå®Œæˆ</p></blockquote> <h3 id="_4-3-trigger-â˜ï¸-äº‘å‡½æ•°é…ç½®æ¨¡ç‰ˆ"><a href="#_4-3-trigger-â˜ï¸-äº‘å‡½æ•°é…ç½®æ¨¡ç‰ˆ" class="header-anchor">#</a> 4.3 Trigger â˜ï¸ äº‘å‡½æ•°é…ç½®æ¨¡ç‰ˆ</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">changeEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/*
    A Database Trigger will always call a function with a changeEvent.
    Documentation on ChangeEvents: https://docs.mongodb.com/manual/reference/change-events/

    Access the _id of the changed document:
    const docId = changeEvent.documentKey._id;

    Access the latest version of the changed document
    (with Full Document enabled for Insert, Update, and Replace operations):
    const fullDocument = changeEvent.fullDocument;

    const updateDescription = changeEvent.updateDescription;

    See which fields were changed (if any):
    if (updateDescription) {
      const updatedFields = updateDescription.updatedFields; // A document containing updated fields
    }

    See which fields were removed (if any):
    if (updateDescription) {
      const removedFields = updateDescription.removedFields; // An array of removed fields
    }

    Functions run by Triggers are run as System users and have full access to Services, Functions, and MongoDB Data.

    Access a mongodb service:
    const collection = context.services.get(&lt;SERVICE_NAME&gt;).db(&quot;db_name&quot;).collection(&quot;coll_name&quot;);
    const doc = collection.findOne({ name: &quot;mongodb&quot; });

    Note: In Atlas Triggers, the service name is defaulted to the cluster name.

    Call other named functions if they are defined in your application:
    const result = context.functions.execute(&quot;function_name&quot;, arg1, arg2);

    Access the default http client and execute a GET request:
    const response = context.http.get({ url: &lt;URL&gt; })

    Learn more about http client here: https://www.mongodb.com/docs/atlas/app-services/functions/context/#std-label-context-http
  */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><hr> <h2 id="_4-trigger-å’Œ-hook-çš„å®ç°åŸç†"><a href="#_4-trigger-å’Œ-hook-çš„å®ç°åŸç†" class="header-anchor">#</a> 4.  Trigger å’Œ  hook çš„å®ç°åŸç†</h2> <blockquote><p>MongoDBçš„æœ¬åœ°é’©å­å’Œäº‘ç«¯è§¦å‘å™¨åœ¨å®ç°åŸç†ä¸Šæœ‰ä¸€äº›åŒºåˆ«ã€‚</p></blockquote> <h3 id="_4-1-æœ¬åœ°-hook-çš„å®ç°åŸç†"><a href="#_4-1-æœ¬åœ°-hook-çš„å®ç°åŸç†" class="header-anchor">#</a> 4.1 æœ¬åœ° hook çš„å®ç°åŸç†</h3> <blockquote><p>æœ¬åœ°é’©å­æ˜¯é€šè¿‡åœ¨åº”ç”¨ç¨‹åºä»£ç ä¸­å®šä¹‰çš„å›è°ƒå‡½æ•°å®ç°çš„,å®ç°åŸç†ä¸»è¦æ¶‰åŠä»¥ä¸‹æ­¥éª¤ï¼š</p></blockquote> <ul><li>åœ¨åº”ç”¨ç¨‹åºä¸­æ³¨å†Œé’©å­å‡½æ•°ï¼ŒæŒ‡å®šåœ¨ç‰¹å®šäº‹ä»¶å‘ç”Ÿå‰æˆ–åè¦æ‰§è¡Œçš„é€»è¾‘ã€‚</li> <li>å½“æ•°æ®åº“æ“ä½œå‘ç”Ÿæ—¶ï¼Œåº”ç”¨ç¨‹åºå°†è°ƒç”¨ç›¸åº”çš„é’©å­å‡½æ•°ï¼Œæ‰§è¡Œé¢„å®šä¹‰çš„é€»è¾‘ã€‚</li> <li>é’©å­å‡½æ•°çš„æ‰§è¡Œæ˜¯åœ¨åº”ç”¨ç¨‹åºçš„è¿›ç¨‹å†…éƒ¨è¿›è¡Œçš„ï¼Œä¸æ¶‰åŠç½‘ç»œé€šä¿¡ã€‚</li></ul> <h3 id="_4-2-äº‘ç«¯è§¦å‘å™¨çš„å®ç°åŸç†"><a href="#_4-2-äº‘ç«¯è§¦å‘å™¨çš„å®ç°åŸç†" class="header-anchor">#</a> 4.2 äº‘ç«¯è§¦å‘å™¨çš„å®ç°åŸç†</h3> <blockquote><p>äº‘ç«¯è§¦å‘å™¨æ˜¯é€šè¿‡MongoDB Realmæˆ–å…¶ä»–ç±»ä¼¼çš„æœåŠ¡å™¨ç«¯æ¡†æ¶æ¥å®ç°çš„ã€‚è§¦å‘å™¨åœ¨MongoDBæœåŠ¡å™¨ä¸Šå®šä¹‰å’Œæ‰§è¡Œï¼Œå®ƒä»¬ä¸ç‰¹å®šé›†åˆç›¸å…³è”ï¼Œå¹¶åœ¨æ»¡è¶³è§¦å‘æ¡ä»¶æ—¶æ‰§è¡Œé’©å­é€»è¾‘ã€‚äº‘ç«¯è§¦å‘å™¨çš„å®ç°åŸç†ä¸»è¦æ¶‰åŠä»¥ä¸‹æ­¥éª¤ï¼š</p></blockquote> <ul><li>åœ¨MongoDB Realmæˆ–å…¶ä»–æœåŠ¡å™¨ç«¯æ¡†æ¶ä¸­å®šä¹‰è§¦å‘å™¨ï¼Œå¹¶æŒ‡å®šè§¦å‘å™¨è¦ç›‘å¬çš„é›†åˆå’Œè§¦å‘æ¡ä»¶ã€‚</li> <li>å½“æ»¡è¶³è§¦å‘æ¡ä»¶æ—¶ï¼ŒæœåŠ¡å™¨ä¼šè§¦å‘ç›¸åº”çš„è§¦å‘å™¨ã€‚</li> <li>è§¦å‘å™¨å†…éƒ¨åŒ…å«äº†é¢„å®šä¹‰çš„é’©å­é€»è¾‘ï¼Œæ ¹æ®å®šä¹‰çš„é€»è¾‘æ‰§è¡Œä¸€ç³»åˆ—æ“ä½œã€‚</li> <li>äº‘ç«¯è§¦å‘å™¨çš„æ‰§è¡Œå‘ç”Ÿåœ¨æœåŠ¡å™¨ç«¯ï¼Œå¯ä»¥æ¶‰åŠä¸æ•°æ®åº“çš„äº¤äº’å’Œå…¶ä»–ç½‘ç»œé€šä¿¡ã€‚</li></ul> <div class="custom-block warning"><p class="title"></p><p>ğŸ‘€ æœ¬åœ°é’©å­æ˜¯åœ¨åº”ç”¨ç¨‹åºä»£ç ä¸­å®šä¹‰å’Œæ‰§è¡Œçš„ï¼Œè€Œäº‘ç«¯è§¦å‘å™¨æ˜¯åœ¨æœåŠ¡å™¨ç«¯å®šä¹‰å’Œæ‰§è¡Œçš„ã€‚</p> <ul><li>æœ¬åœ°é’©å­ç›´æ¥ä¸æ•°æ®åº“æ“ä½œåœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹å†…éƒ¨äº¤äº’</li> <li>è€Œäº‘ç«¯è§¦å‘å™¨é€šè¿‡æœåŠ¡å™¨ç«¯æ¡†æ¶ä¸MongoDBæœåŠ¡å™¨è¿›è¡Œäº¤äº’ã€‚</li></ul></div><hr> <h2 id="_5-hook-å®æˆ˜åº”ç”¨"><a href="#_5-hook-å®æˆ˜åº”ç”¨" class="header-anchor">#</a> 5. Hook å®æˆ˜åº”ç”¨</h2> <h3 id="âš ï¸-å‹-å…-æƒ…-è´£-æç¤º"><a href="#âš ï¸-å‹-å…-æƒ…-è´£-æç¤º" class="header-anchor">#</a> âš ï¸ å‹ï¼ˆå…ï¼‰æƒ…ï¼ˆè´£ï¼‰æç¤º</h3> <div class="custom-block warning"><p class="title"></p><p>ğŸ‘€ åœ¨Mongooseä¸­ï¼Œåœ¨hookï¼ˆé’©å­ï¼‰ä¸­åŠ å…¥ä¸šåŠ¡é€»è¾‘ä»£ç ä¸æ˜¯ç»å¯¹çš„å±é™©ï¼Œä½†æ˜¯éœ€è¦å°å¿ƒä½¿ç”¨ï¼Œå› ä¸ºä¸å½“ä½¿ç”¨å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜å’Œä¸è‰¯å½±å“ã€‚
Hooksæ˜¯åœ¨æ•°æ®åº“æ“ä½œï¼ˆä¾‹å¦‚ä¿å­˜æ–‡æ¡£ã€æ›´æ–°æ–‡æ¡£ã€åˆ é™¤æ–‡æ¡£ç­‰ï¼‰å‰åè§¦å‘çš„å‡½æ•°ï¼Œå…è®¸æ‚¨åœ¨è¿›è¡Œæ•°æ®åº“æ“ä½œä¹‹å‰æˆ–ä¹‹åæ‰§è¡Œä¸€äº›è‡ªå®šä¹‰é€»è¾‘ã€‚å½“åˆç†ä½¿ç”¨æ—¶ï¼Œhookså¯ä»¥å¸®åŠ©æ‚¨åœ¨ä¸ä¿®æ”¹æ•°æ®åº“æ“ä½œçš„æƒ…å†µä¸‹ï¼Œå¢åŠ æˆ–ä¿®æ”¹æ•°æ®ã€æ‰§è¡ŒéªŒè¯ã€å¤„ç†å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ç­‰ã€‚</p></div><div class="custom-block danger"><p class="title"></p><p>ä»¥ä¸‹æ˜¯åœ¨hooksä¸­åŠ å…¥ä¸šåŠ¡é€»è¾‘æ—¶åº”è€ƒè™‘çš„ä¸€äº›æ½œåœ¨é£é™©ï¼š</p> <ol><li>æ€§èƒ½é—®é¢˜ï¼šå¦‚æœhookä¸­çš„ä¸šåŠ¡é€»è¾‘å¾ˆå¤æ‚æˆ–éœ€è¦å¤§é‡è®¡ç®—ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®åº“æ“ä½œå˜æ…¢ï¼Œä»è€Œå½±å“æ•´ä½“æ€§èƒ½ã€‚</li> <li>æ­»å¾ªç¯ï¼šåœ¨hookä¸­æ‰§è¡Œæ•°æ®åº“æ“ä½œï¼ˆä¾‹å¦‚ä¿å­˜æ–‡æ¡£ï¼‰å¯èƒ½å¯¼è‡´æ— é™å¾ªç¯ï¼Œä»è€Œå¼•å‘æ ˆæº¢å‡ºæˆ–å…¶ä»–é—®é¢˜ã€‚</li> <li>å¼‚å¸¸å¤„ç†ï¼šå¦‚æœåœ¨hookä¸­æ²¡æœ‰é€‚å½“å¤„ç†å¼‚å¸¸ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœªæ•è·çš„é”™è¯¯ï¼Œä½¿åº”ç”¨ç¨‹åºå´©æºƒæˆ–å‡ºç°æœªçŸ¥è¡Œä¸ºã€‚</li> <li>é’©å­åµŒå¥—ï¼šå½“ä½¿ç”¨å¤šä¸ªé’©å­æ—¶ï¼Œå¯èƒ½ä¼šå‘ç”ŸåµŒå¥—è°ƒç”¨çš„æƒ…å†µï¼Œè¿™å¯èƒ½å¯¼è‡´éš¾ä»¥é¢„æµ‹çš„ç»“æœ</li></ol></div><hr> <h3 id="å®æˆ˜1-åˆ é™¤æ–‡æ¡£çš„åŒæ—¶-åˆ é™¤å·²ä¸Šä¼ çš„é™„ä»¶"><a href="#å®æˆ˜1-åˆ é™¤æ–‡æ¡£çš„åŒæ—¶-åˆ é™¤å·²ä¸Šä¼ çš„é™„ä»¶" class="header-anchor">#</a> å®æˆ˜1 åˆ é™¤æ–‡æ¡£çš„åŒæ—¶ï¼Œåˆ é™¤å·²ä¸Šä¼ çš„é™„ä»¶</h3> <blockquote><ol><li>Apkæ˜¯mongooseå®šä¹‰çš„schema</li> <li>æ–‡ä»¶æå‰ä¼šä¸Šä¼ åˆ° config.uploads.path å¯¹åº”çš„æ–‡ä»¶ä¸‹</li> <li>å•å…ƒæµ‹è¯•ä¸­ï¼ˆprocess.env.NODE_ENV === 'test'ï¼‰ï¼Œä¸ä¼šæ‰§è¡Œå¯¹åº”å†…å®¹</li></ol></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// åˆ é™¤roomæ—¶ï¼Œå¦‚æœimgæœ‰å†…å®¹ï¼Œéœ€è¦åˆ é™¤å¯¹åº”çš„æ–‡ä»¶</span>
apkSchema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'deleteOne'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'test'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> original <span class="token operator">=</span> <span class="token keyword">await</span> Apk<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_conditions<span class="token punctuation">.</span>_id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>original<span class="token punctuation">.</span>fileName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> url <span class="token operator">=</span> config<span class="token punctuation">.</span>uploads<span class="token punctuation">.</span>path <span class="token operator">+</span> original<span class="token punctuation">.</span>fileName<span class="token punctuation">;</span>
            <span class="token keyword">const</span> fileStat <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>fileStat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>ğŸ‘€ ä»¥ä¸Šä»£ç ï¼Œå®ç°äº†åˆ é™¤APKæ—¶ï¼Œä¼šé¡ºå¸¦åˆ é™¤å·²ä¸Šä¼ çš„é™„ä»¶ ğŸ“</p></blockquote> <h3 id="å®æˆ˜2-æ›´æ–°booking-åŒæ­¥å‘é€mqtté€šçŸ¥"><a href="#å®æˆ˜2-æ›´æ–°booking-åŒæ­¥å‘é€mqtté€šçŸ¥" class="header-anchor">#</a> å®æˆ˜2 æ›´æ–°Bookingï¼ŒåŒæ­¥å‘é€mqtté€šçŸ¥</h3> <div class="custom-block tip"><p class="title"></p><p>ğŸ‘€ æ­¤å¤„å°†mqtté€šçŸ¥å†™å…¥hookï¼Œå› ä¸ºé¢„è®¢æœ‰ä»»ä½•æ•°æ®æ”¹åŠ¨ï¼Œéƒ½éœ€è¦åŠæ—¶é€šçŸ¥ä¿¡æ¯å±åˆ·æ–°é¢„è®¢æƒ…å†µ
å¦‚æœä¸å†™å…¥hookä¸­ï¼Œä¼šåœ¨é¡¹ç›®çš„å„å¤„é‡å¤æ’å…¥æ­¤æ®µä»£ç ï¼Œé™ä½ä»£ç çš„å¯è¯»æ€§å’Œæ‰©å±•æ€§</p></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// é¢„è®¢ã€æ›´æ–°çš„é”™è¯¯æŠ›å‡ºä¸èƒ½åœ¨è¿™é‡Œï¼Œmqtté€šçŸ¥å¯ä»¥</span>
bookingSchema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'updateOne'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'test'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> booking <span class="token operator">=</span> <span class="token keyword">await</span> Booking<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_conditions<span class="token punctuation">.</span>_id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> devices <span class="token operator">=</span> <span class="token keyword">await</span> Device<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">room</span><span class="token operator">:</span> booking<span class="token punctuation">.</span>room <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è·å–ä¼šè®®å®¤ä¸‹çš„æ‰€æœ‰è®¾å¤‡</span>
        <span class="token comment">// å‘é€mqttæ¶ˆæ¯ï¼Œé€šçŸ¥è®¾å¤‡åˆ·æ–°ä¼šè®®</span>
        devices<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">device</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            mqttService<span class="token punctuation">.</span><span class="token function">publishRefreshBooking</span><span class="token punctuation">(</span>device<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="å®æˆ˜3-åˆ›å»ºé¢„è®¢æ—¶-æ£€æŸ¥æ•°æ®æ˜¯å¦ç¬¦åˆé¢„æœŸ"><a href="#å®æˆ˜3-åˆ›å»ºé¢„è®¢æ—¶-æ£€æŸ¥æ•°æ®æ˜¯å¦ç¬¦åˆé¢„æœŸ" class="header-anchor">#</a> å®æˆ˜3 åˆ›å»ºé¢„è®¢æ—¶ï¼Œæ£€æŸ¥æ•°æ®æ˜¯å¦ç¬¦åˆé¢„æœŸ</h3> <blockquote><p>â¬‡ï¸ bookingErrors æ˜¯ è‡ªå®šä¹‰çš„ ServiceErrorï¼ŒåŒ…å«codeå’Œmessage</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">20007</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token keyword">null</span>
    <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">&quot;ä¼šè®®æ—¶é—´å†²çª&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// åˆ›å»ºå¯¹è±¡æ—¶ï¼Œè‡ªåŠ¨å¯»æ‰¾ç§Ÿæˆ·</span>
bookingSchema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>tenant<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> tenant <span class="token operator">=</span> <span class="token keyword">await</span> Tenant<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tenant <span class="token operator">=</span> tenant<span class="token punctuation">.</span>_id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> now <span class="token operator">=</span> <span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>beginAt<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beginAt <span class="token operator">=</span> now<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>planBeginAt<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>planBeginAt <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beginAt<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>planEndAt<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>planEndAt <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>endAt<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beginAt <span class="token operator">&lt;</span> now<span class="token punctuation">)</span> bookingErrors<span class="token punctuation">.</span><span class="token function">beginAtLessThanNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// ä¸ å…¨å±€é…ç½®ç›¸å…³ çš„åˆ¤æ–­</span>
    <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token keyword">await</span> Config<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beginAt <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>endAt<span class="token punctuation">)</span> bookingErrors<span class="token punctuation">.</span><span class="token function">beginAtGreaterThanEndAt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å¼€å§‹æ—¶é—´å¤§äºç»“æŸæ—¶é—´</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>maxBookingDay <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>endAt <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beginAt <span class="token operator">&gt;</span> config<span class="token punctuation">.</span>maxBookingDay <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span>
        bookingErrors<span class="token punctuation">.</span><span class="token function">bookingDayGreaterThanMaxBookingDay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token constant">X</span><span class="token operator">:</span> config<span class="token punctuation">.</span>maxBookingDay <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ä¼šè®®æ—¶é•¿å¤§äºæœ€å¤§é¢„çº¦æ—¶é•¿</span>

    <span class="token comment">// åˆ¤æ–­æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ä¼šè®®å®¤å’Œåˆ›å»ºäºº</span>
    <span class="token keyword">const</span> room <span class="token operator">=</span> <span class="token keyword">await</span> Room<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>room <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> creator <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>creator <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>room<span class="token punctuation">)</span> bookingErrors<span class="token punctuation">.</span><span class="token function">roomNotFound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>room<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'disable'</span><span class="token punctuation">)</span> bookingErrors<span class="token punctuation">.</span><span class="token function">roomDisabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>creator<span class="token punctuation">)</span> bookingErrors<span class="token punctuation">.</span><span class="token function">userNotFound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> validBookings <span class="token operator">=</span> <span class="token keyword">await</span> Booking<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">room</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>room<span class="token punctuation">,</span> <span class="token literal-property property">endAt</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">$gte</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beginAt <span class="token operator">-</span> config<span class="token punctuation">.</span>preTime <span class="token operator">*</span> <span class="token number">60</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">beginAt</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">$lte</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>endAt <span class="token operator">+</span> config<span class="token punctuation">.</span>preTime <span class="token operator">*</span> <span class="token number">60</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token punctuation">{</span> $<span class="token keyword">in</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'success'</span><span class="token punctuation">,</span> <span class="token string">'start'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>validBookings<span class="token punctuation">.</span>length<span class="token punctuation">)</span> bookingErrors<span class="token punctuation">.</span><span class="token function">bookingConflict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'test'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> devices <span class="token operator">=</span> <span class="token keyword">await</span> Device<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">room</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>room <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è·å–ä¼šè®®å®¤ä¸‹çš„æ‰€æœ‰è®¾å¤‡</span>
        <span class="token comment">// å‘é€mqttæ¶ˆæ¯ï¼Œé€šçŸ¥è®¾å¤‡åˆ·æ–°ä¼šè®®</span>
        devices<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">device</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            mqttService<span class="token punctuation">.</span><span class="token function">publishRefreshBooking</span><span class="token punctuation">(</span>device<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><details class="custom-block details"><summary>ä¸Šè¿°ä»£ç ï¼Œé€šè¿‡è°ƒç”¨ save hookï¼Œå®ç°äº†ä»¥ä¸‹éœ€æ±‚ï¼š</summary> <ol><li>å¡«å……ç§Ÿæˆ·id</li> <li>ä¸èƒ½åˆ›å»ºå½“å‰æ—¶é—´ä¹‹å‰çš„ä¼šè®®</li> <li>å¼€å§‹æ—¶é—´ä¸èƒ½è¶…è¿‡ç»“æŸæ—¶é—´</li> <li>é¢„è®¢æ—¶é•¿ä¸èƒ½è¶…è¿‡å…¨å±€é…ç½®ä¸­è®¾ç½®çš„æœ€å¤§é¢„è®¢æ—¶é—´</li> <li>åˆ¤æ–­ä¼šè®®å®¤æ˜¯å¦å­˜åœ¨</li> <li>åˆ¤æ–­åˆ›å»ºè€…æ˜¯å¦å­˜åœ¨</li> <li>åˆ¤æ–­æ˜¯å¦æœ‰ä¼šè®®æ—¶é—´å†²çª</li> <li>åŒæ­¥å‘é€mqtté€šçŸ¥</li></ol></details> <div class="custom-block tip"><p class="title"></p><p>âœ… å°½é‡ä¸è¦åœ¨hookä¸­é‡å¤è§¦å‘æ•°æ®åº“æ“ä½œï¼Œè€Œæ˜¯åœ¨hookä¸­åšä¸€äº›ç®€å•çš„éªŒè¯æˆ–æ•°æ®ä¿®æ”¹ã€‚å¯¹äºå¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼Œæœ€å¥½å°†å…¶æ”¾åœ¨å…¶ä»–æ¨¡å—æˆ–æœåŠ¡ä¸­ï¼Œå¹¶ä»hookä¸­è°ƒç”¨è¿™äº›æ¨¡å—ã€‚
åŒæ—¶ï¼Œç¼–å†™å®Œå–„çš„æµ‹è¯•ä¹Ÿæ˜¯éå¸¸é‡è¦çš„ï¼Œä»¥ç¡®ä¿åœ¨æ·»åŠ hooké€»è¾‘æ—¶ä¸ä¼šå¼•å…¥æ½œåœ¨çš„é—®é¢˜ã€‚
æµ‹è¯•å¯ä»¥å¸®åŠ©æ‚¨éªŒè¯é’©å­çš„è¡Œä¸ºæ˜¯å¦ç¬¦åˆé¢„æœŸï¼Œå¹¶ä¸”åœ¨è¿›è¡Œæ›´æ”¹æ—¶å¯ä»¥æä¾›æ›´å¤§çš„ä¿¡å¿ƒã€‚</p></div><p>æ€»ä¹‹ï¼Œä½¿ç”¨hooksæ¥åŠ å…¥ä¸šåŠ¡é€»è¾‘æ˜¯ä¸€ç§å¸¸è§çš„åšæ³•ï¼Œä½†éœ€è¦è°¨æ…ä½¿ç”¨ï¼Œä»¥é¿å…æ½œåœ¨çš„é—®é¢˜ã€‚
éµå¾ªæœ€ä½³å®è·µï¼Œå¹¶è¿›è¡Œå……åˆ†çš„æµ‹è¯•æ˜¯ç¡®ä¿å®‰å…¨æ€§å’Œç¨³å®šæ€§çš„å…³é”®ã€‚</p> <h2 id="_6-æ€»ç»“"><a href="#_6-æ€»ç»“" class="header-anchor">#</a> 6. æ€»ç»“</h2> <p>MongoDB Hook æ˜¯ MongoDB æ•°æ®åº“æä¾›çš„ä¸€ç§æ‰©å±•åŠŸèƒ½ï¼Œå®ƒå¯ä»¥åœ¨æ•°æ®åº“æ“ä½œå‰åæ‰§è¡Œé¢å¤–çš„ä»£ç æˆ–æ“ä½œã€‚
é€šè¿‡ä½¿ç”¨ MongoDB Hookï¼Œæ‚¨å¯ä»¥ä¸ºæ•°æ®åº“æ“ä½œæ·»åŠ è‡ªå®šä¹‰é€»è¾‘ï¼Œæé«˜åº”ç”¨ç¨‹åºçš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ã€‚
MongoDB Hook å¯ä»¥åº”ç”¨äº CRUD æ“ä½œçš„å…¨è¿‡ç¨‹ï¼Œå¦‚æŸ¥è¯¢ã€æ’å…¥ã€æ›´æ–°å’Œåˆ é™¤ç­‰ã€‚</p> <p>MongoDB Atlas æ˜¯ MongoDB å…¬å¸æä¾›çš„äº‘æ•°æ®åº“æœåŠ¡ã€‚å®ƒæ˜¯åŸºäºäº‘å¹³å°çš„å…¨æ‰˜ç®¡æ•°æ®åº“æœåŠ¡
MongoDB Atlas ç®€åŒ–äº†åœ¨äº‘ä¸­ç®¡ç† MongoDB æ•°æ®åº“çš„è¿‡ç¨‹ï¼Œä¸ºæ‚¨çš„æ•°æ®å­˜å‚¨å’Œç®¡ç†éœ€æ±‚æä¾›å¯æ‰©å±•ä¸”å®‰å…¨çš„è§£å†³æ–¹æ¡ˆ</p></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/backend/mongodb/hook/#_1-å‰è¨€" class="sidebar-link reco-side-_1-å‰è¨€" data-v-b57cc07c>1. å‰è¨€</a></li><li class="level-3" data-v-b57cc07c><a href="/backend/mongodb/hook/#ç¤ºä¾‹1-ç®€å•ä½¿ç”¨" class="sidebar-link reco-side-ç¤ºä¾‹1-ç®€å•ä½¿ç”¨" data-v-b57cc07c>ç¤ºä¾‹1 ç®€å•ä½¿ç”¨</a></li><li class="level-3" data-v-b57cc07c><a href="/backend/mongodb/hook/#ç¤ºä¾‹2-æ£€æŸ¥bookingçš„å¼€å§‹ç»“æŸæ—¶é—´" class="sidebar-link reco-side-ç¤ºä¾‹2-æ£€æŸ¥bookingçš„å¼€å§‹ç»“æŸæ—¶é—´" data-v-b57cc07c>ç¤ºä¾‹2 æ£€æŸ¥Bookingçš„å¼€å§‹ç»“æŸæ—¶é—´</a></li><li class="level-3" data-v-b57cc07c><a href="/backend/mongodb/hook/#post-middleware-å¯¹åº”æ‰§è¡Œé¡ºåº" class="sidebar-link reco-side-post-middleware-å¯¹åº”æ‰§è¡Œé¡ºåº" data-v-b57cc07c>* Post middleware å¯¹åº”æ‰§è¡Œé¡ºåº</a></li><li class="level-2" data-v-b57cc07c><a href="/backend/mongodb/hook/#_2-hook-tips" class="sidebar-link reco-side-_2-hook-tips" data-v-b57cc07c>2. Hook Tips</a></li><li class="level-3" data-v-b57cc07c><a href="/backend/mongodb/hook/#_2-1-hook-early-return" class="sidebar-link reco-side-_2-1-hook-early-return" data-v-b57cc07c>2.1  Hook Early Return</a></li><li class="level-3" data-v-b57cc07c><a href="/backend/mongodb/hook/#_2-2-this-å…³é”®å­—" class="sidebar-link reco-side-_2-2-this-å…³é”®å­—" data-v-b57cc07c>2.2  This å…³é”®å­—</a></li><li class="level-2" data-v-b57cc07c><a href="/backend/mongodb/hook/#_3-ğŸªè¿œç¨‹-trigger-å’Œ-æœ¬åœ°-hook-çš„åŒºåˆ«" class="sidebar-link reco-side-_3-ğŸªè¿œç¨‹-trigger-å’Œ-æœ¬åœ°-hook-çš„åŒºåˆ«" data-v-b57cc07c>3. ğŸªè¿œç¨‹ Trigger å’Œ æœ¬åœ° hook çš„åŒºåˆ«</a></li><li class="level-3" data-v-b57cc07c><a href="/backend/mongodb/hook/#_4-1-mongodb-atlas" class="sidebar-link reco-side-_4-1-mongodb-atlas" data-v-b57cc07c>4.1  MongoDB Atlas</a></li><li class="level-3" data-v-b57cc07c><a href="/backend/mongodb/hook/#_4-2-trigger-é…ç½®ç•Œé¢" class="sidebar-link reco-side-_4-2-trigger-é…ç½®ç•Œé¢" data-v-b57cc07c>4.2  Trigger é…ç½®ç•Œé¢</a></li><li class="level-3" data-v-b57cc07c><a href="/backend/mongodb/hook/#_4-3-trigger-â˜ï¸-äº‘å‡½æ•°é…ç½®æ¨¡ç‰ˆ" class="sidebar-link reco-side-_4-3-trigger-â˜ï¸-äº‘å‡½æ•°é…ç½®æ¨¡ç‰ˆ" data-v-b57cc07c>4.3 Trigger â˜ï¸ äº‘å‡½æ•°é…ç½®æ¨¡ç‰ˆ</a></li><li class="level-2" data-v-b57cc07c><a href="/backend/mongodb/hook/#_4-trigger-å’Œ-hook-çš„å®ç°åŸç†" class="sidebar-link reco-side-_4-trigger-å’Œ-hook-çš„å®ç°åŸç†" data-v-b57cc07c>4.  Trigger å’Œ  hook çš„å®ç°åŸç†</a></li><li class="level-3" data-v-b57cc07c><a href="/backend/mongodb/hook/#_4-1-æœ¬åœ°-hook-çš„å®ç°åŸç†" class="sidebar-link reco-side-_4-1-æœ¬åœ°-hook-çš„å®ç°åŸç†" data-v-b57cc07c>4.1 æœ¬åœ° hook çš„å®ç°åŸç†</a></li><li class="level-3" data-v-b57cc07c><a href="/backend/mongodb/hook/#_4-2-äº‘ç«¯è§¦å‘å™¨çš„å®ç°åŸç†" class="sidebar-link reco-side-_4-2-äº‘ç«¯è§¦å‘å™¨çš„å®ç°åŸç†" data-v-b57cc07c>4.2 äº‘ç«¯è§¦å‘å™¨çš„å®ç°åŸç†</a></li><li class="level-2" data-v-b57cc07c><a href="/backend/mongodb/hook/#_5-hook-å®æˆ˜åº”ç”¨" class="sidebar-link reco-side-_5-hook-å®æˆ˜åº”ç”¨" data-v-b57cc07c>5. Hook å®æˆ˜åº”ç”¨</a></li><li class="level-3" data-v-b57cc07c><a href="/backend/mongodb/hook/#âš ï¸-å‹-å…-æƒ…-è´£-æç¤º" class="sidebar-link reco-side-âš ï¸-å‹-å…-æƒ…-è´£-æç¤º" data-v-b57cc07c>âš ï¸ å‹ï¼ˆå…ï¼‰æƒ…ï¼ˆè´£ï¼‰æç¤º</a></li><li class="level-3" data-v-b57cc07c><a href="/backend/mongodb/hook/#å®æˆ˜1-åˆ é™¤æ–‡æ¡£çš„åŒæ—¶-åˆ é™¤å·²ä¸Šä¼ çš„é™„ä»¶" class="sidebar-link reco-side-å®æˆ˜1-åˆ é™¤æ–‡æ¡£çš„åŒæ—¶-åˆ é™¤å·²ä¸Šä¼ çš„é™„ä»¶" data-v-b57cc07c>å®æˆ˜1 åˆ é™¤æ–‡æ¡£çš„åŒæ—¶ï¼Œåˆ é™¤å·²ä¸Šä¼ çš„é™„ä»¶</a></li><li class="level-3" data-v-b57cc07c><a href="/backend/mongodb/hook/#å®æˆ˜2-æ›´æ–°booking-åŒæ­¥å‘é€mqtté€šçŸ¥" class="sidebar-link reco-side-å®æˆ˜2-æ›´æ–°booking-åŒæ­¥å‘é€mqtté€šçŸ¥" data-v-b57cc07c>å®æˆ˜2 æ›´æ–°Bookingï¼ŒåŒæ­¥å‘é€mqtté€šçŸ¥</a></li><li class="level-3" data-v-b57cc07c><a href="/backend/mongodb/hook/#å®æˆ˜3-åˆ›å»ºé¢„è®¢æ—¶-æ£€æŸ¥æ•°æ®æ˜¯å¦ç¬¦åˆé¢„æœŸ" class="sidebar-link reco-side-å®æˆ˜3-åˆ›å»ºé¢„è®¢æ—¶-æ£€æŸ¥æ•°æ®æ˜¯å¦ç¬¦åˆé¢„æœŸ" data-v-b57cc07c>å®æˆ˜3 åˆ›å»ºé¢„è®¢æ—¶ï¼Œæ£€æŸ¥æ•°æ®æ˜¯å¦ç¬¦åˆé¢„æœŸ</a></li><li class="level-2" data-v-b57cc07c><a href="/backend/mongodb/hook/#_6-æ€»ç»“" class="sidebar-link reco-side-_6-æ€»ç»“" data-v-b57cc07c>6. æ€»ç»“</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div><div class="sponsor-container" data-v-a142c76a><div class="sponsor-love position-absolute transition-3ms" data-v-a142c76a>
    Sponsor
  </div> <a href="https://github.com/yokefellow/vuepress-plugin-sponsor" target="_blank" title="Github" class="sponsor-github position-absolute transition-3ms" data-v-a142c76a></a> <ul class="sponsor-payment-options transition-3ms" data-v-a142c76a><li id="alipay-option" class="transition-3ms" data-v-a142c76a></li> <li id="wechat-option" class="transition-3ms" data-v-a142c76a></li> <li id="qq-option" class="transition-3ms" data-v-a142c76a></li> <li id="paypal-option" class="transition-3ms" data-v-a142c76a></li></ul> <div class="sponsor-qrcode-container position-absolute" style="display:none;" data-v-a142c76a data-v-a142c76a><div class="sponsor-qrcode-info" style="background-image:url();pointer-events:none;display:none;" data-v-a142c76a data-v-a142c76a></div></div> <div class="sponsor-message position-absolute" style="display:none;" data-v-a142c76a data-v-a142c76a>
      ä¸»äººå¿˜è®°è®¾ç½®å•¦
    </div></div></div></div></div>
    <script src="/assets/js/app.be8121bb.js" defer></script><script src="/assets/js/7.1077a71e.js" defer></script><script src="/assets/js/2.e054aee5.js" defer></script><script src="/assets/js/1.388f40f4.js" defer></script><script src="/assets/js/47.197a6718.js" defer></script>
  </body>
</html>
